import React, { useState, useMemo } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line, PieChart, Pie, Cell, ComposedChart, Area } from 'recharts';

// ============================================
// F&F Corporation Q4 2025 Financial Dashboard
// shadcn/ui ìŠ¤íƒ€ì¼ ì ìš©
// ============================================

// ì»¤ìŠ¤í…€ ë„ë„› ì°¨íŠ¸ íˆ´íŒ ì»´í¬ë„ŒíŠ¸
const CustomPieTooltip = ({ active, payload, formatter }) => {
  if (active && payload && payload.length) {
    const data = payload[0];
    const color = data.payload.color;
    const name = data.name;
    const value = formatter ? formatter(data.value) : data.value;
    
    return (
      <div className="bg-white/95 backdrop-blur-sm border border-zinc-200 rounded-lg shadow-lg px-3 py-2 min-w-[160px]">
        <div className="flex items-center gap-2 mb-1">
          <span 
            className="w-2.5 h-2.5 rounded-full flex-shrink-0" 
            style={{ backgroundColor: color }}
          />
          <span className="text-xs font-medium text-zinc-700 whitespace-nowrap">{name}</span>
        </div>
        <div className="text-sm font-semibold text-zinc-900 pl-4 whitespace-nowrap">{value}</div>
      </div>
    );
  }
  return null;
};

// ì»¤ìŠ¤í…€ ì°¨íŠ¸ íˆ´íŒ ì»´í¬ë„ŒíŠ¸
const CustomChartTooltip = ({ active, payload, label }) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-white/95 backdrop-blur-sm border border-zinc-200 rounded-lg shadow-lg px-3 py-2.5 min-w-[140px]">
        <p className="text-xs font-medium text-zinc-500 mb-1.5 pb-1.5 border-b border-zinc-100 whitespace-nowrap">{label}</p>
        <div className="space-y-1">
          {payload.map((entry, index) => (
            <div key={index} className="flex items-center justify-between gap-3">
              <div className="flex items-center gap-1.5">
                <span 
                  className="w-2 h-2 rounded-full flex-shrink-0" 
                  style={{ backgroundColor: entry.color }}
                />
                <span className="text-xs text-zinc-600 whitespace-nowrap">{entry.name || entry.dataKey}</span>
              </div>
              <span className="text-xs font-semibold text-zinc-900 whitespace-nowrap">{entry.value?.toLocaleString()}</span>
            </div>
          ))}
        </div>
      </div>
    );
  }
  return null;
};

export default function FnFQ4Dashboard() {
  const [activeTab, setActiveTab] = useState('summary');
  const [selectedAccount, setSelectedAccount] = useState('ë§¤ì¶œì•¡');
  const [selectedBSAccount, setSelectedBSAccount] = useState('ìì‚°ì´ê³„');
  const [isNonOperatingExpanded, setIsNonOperatingExpanded] = useState(false);
  const [incomeViewMode, setIncomeViewMode] = useState('quarter'); // 'quarter' | 'annual'
  const [selectedPeriod, setSelectedPeriod] = useState('2025_Q4'); // ì„ íƒëœ ì¡°íšŒê¸°ê°„ ('2025_Q1' ~ '2025_Q4')

  // ============================================
  // ê¸°ê°„ ë§¤í•‘ í•¨ìˆ˜
  // ============================================
  const getPeriodKey = (selectedPeriod, type) => {
    // selectedPeriod: '2025_Q1', '2025_Q2', '2025_Q3', '2025_Q4'
    // type: 'quarter' (ë¶„ê¸°), 'year' (ëˆ„ì ), 'prev_quarter' (ì „ë…„ ë™ ë¶„ê¸°), 'prev_year' (ì „ë…„ ë™ê¸° ëˆ„ì )
    const [year, quarter] = selectedPeriod.split('_');
    const yearNum = parseInt(year);
    const quarterNum = quarter.replace('Q', '');
    
    if (type === 'quarter') {
      return `${year}_${quarterNum}Q`;
    } else if (type === 'year') {
      // ëˆ„ì : Q4ëŠ” '2025_Year', Q1~Q3ëŠ” '2025_1Q_Year' í˜•ì‹
      if (quarterNum === '4') {
        return `${year}_Year`;
      }
      return `${year}_${quarterNum}Q_Year`;
    } else if (type === 'prev_quarter') {
      const prevYear = (yearNum - 1).toString();
      return `${prevYear}_${quarterNum}Q`;
    } else if (type === 'prev_year') {
      const prevYear = (yearNum - 1).toString();
      // ì „ë…„ ë™ê¸° ëˆ„ì : Q4ëŠ” '2024_Year', Q1~Q3ëŠ” '2024_1Q_Year' í˜•ì‹
      if (quarterNum === '4') {
        return `${prevYear}_Year`;
      }
      return `${prevYear}_${quarterNum}Q_Year`;
    }
    return `${year}_4Q`; // ê¸°ë³¸ê°’
  };

  const getPeriodLabel = (selectedPeriod) => {
    // '2025_Q4' -> 'FY2025 Q4'
    return selectedPeriod.replace('_', ' ');
  };

  // ============================================
  // ì¬ë¬´ìƒíƒœí‘œ ì¡°íšŒ ê¸°ì¤€(ì»´í¬ë„ŒíŠ¸ ì „ì—­)
  // - ì¬ë¬´ìƒíƒœí‘œëŠ” ì„ íƒ ë¶„ê¸° ê¸°ë§ vs ì „ë…„ ê¸°ë§ ë¹„êµ
  // ============================================
  const bsCurrentPeriod = getPeriodKey(selectedPeriod, 'quarter'); // ì„ íƒëœ ë¶„ê¸° ê¸°ë§
  const bsPrevPeriod = '2024_4Q'; // ì „ë…„ ê¸°ë§ (ê³ ì •)

    // ============================================
  // ì†ìµê³„ì‚°ì„œ ë°ì´í„° - ë¶„ê¸°(3ê°œì›”) + ëˆ„ì (ì—°ê°„) í†µí•© (CSV ê¸°ë°˜)
  // ============================================
  const incomeStatementData = {
    // 2024ë…„ ë¶„ê¸° (3ê°œì›”)
    '2024_1Q': {
      ë§¤ì¶œì•¡: 507029,
      ë§¤ì¶œì›ê°€: 174545,
      ë§¤ì¶œì´ì´ìµ: 332484,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 202273,
      ì¸ê±´ë¹„: 19658,
      ê´‘ê³ ì„ ì „ë¹„: 24097,
      ìˆ˜ìˆ˜ë£Œ: 118770,
      ê°ê°€ìƒê°ë¹„: 20565,
      ê¸°íƒ€íŒê´€ë¹„: 19183,
      ì˜ì—…ì´ìµ: 130211,
      ì˜ì—…ì™¸ì†ìµ: 21031,
      ì™¸í™˜ì†ìµ: 10008,
      ì„ ë¬¼í™˜ì†ìµ: 473,
      ê¸ˆìœµìƒí’ˆì†ìµ: 1941,
      ì´ìì†ìµ: 4736,
      ë°°ë‹¹ìˆ˜ìµ: 62,
      ê¸°íƒ€ì†ìµ: 2913,
      ì§€ë¶„ë²•ì†ìµ: 803,
      ê¸°ë¶€ê¸ˆ: 94,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 128159,
      ë²•ì¸ì„¸ë¹„ìš©: 31837,
      ë‹¹ê¸°ìˆœì´ìµ: 96322,
    },
    '2024_2Q': {
      ë§¤ì¶œì•¡: 391473,
      ë§¤ì¶œì›ê°€: 120174,
      ë§¤ì¶œì´ì´ìµ: 271299,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 179497,
      ì¸ê±´ë¹„: 22002,
      ê´‘ê³ ì„ ì „ë¹„: 16955,
      ìˆ˜ìˆ˜ë£Œ: 102336,
      ê°ê°€ìƒê°ë¹„: 21537,
      ê¸°íƒ€íŒê´€ë¹„: 16667,
      ì˜ì—…ì´ìµ: 91802,
      ì˜ì—…ì™¸ì†ìµ: 16367,
      ì™¸í™˜ì†ìµ: 5536,
      ì„ ë¬¼í™˜ì†ìµ: 471,
      ê¸ˆìœµìƒí’ˆì†ìµ: 748,
      ì´ìì†ìµ: 4846,
      ë°°ë‹¹ìˆ˜ìµ: 2144,
      ê¸°íƒ€ì†ìµ: 1412,
      ì§€ë¶„ë²•ì†ìµ: 800,
      ê¸°ë¶€ê¸ˆ: 409,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 97956,
      ë²•ì¸ì„¸ìš©: 24005,
      ë²•ì¸ì„¸ë¹„ìš©: 24005,
      ë‹¹ê¸°ìˆœì´ìµ: 73951,
    },
    '2024_3Q': {
      ë§¤ì¶œì•¡: 450963,
      ë§¤ì¶œì›ê°€: 166042,
      ë§¤ì¶œì´ì´ìµ: 284921,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 176618,
      ì¸ê±´ë¹„: 19926,
      ê´‘ê³ ì„ ì „ë¹„: 19902,
      ìˆ˜ìˆ˜ë£Œ: 96464,
      ê°ê°€ìƒê°ë¹„: 23267,
      ê¸°íƒ€íŒê´€ë¹„: 17059,
      ì˜ì—…ì´ìµ: 108303,
      ì˜ì—…ì™¸ì†ìµ: 32491,
      ì™¸í™˜ì†ìµ: 5066,
      ì„ ë¬¼í™˜ì†ìµ: 1022,
      ê¸ˆìœµìƒí’ˆì†ìµ: 2468,
      ì´ìì†ìµ: 4486,
      ë°°ë‹¹ìˆ˜ìµ: 1088,
      ê¸°íƒ€ì†ìµ: 7353,
      ì§€ë¶„ë²•ì†ìµ: 9098,
      ê¸°ë¶€ê¸ˆ: 1910,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 109840,
      ë²•ì¸ì„¸ë¹„ìš©: 30039,
      ë‹¹ê¸°ìˆœì´ìµ: 79801,
    },
    '2024_4Q': {
      ë§¤ì¶œì•¡: 546545,
      ë§¤ì¶œì›ê°€: 188255,
      ë§¤ì¶œì´ì´ìµ: 358290,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 237871,
      ì¸ê±´ë¹„: 22685,
      ê´‘ê³ ì„ ì „ë¹„: 32179,
      ìˆ˜ìˆ˜ë£Œ: 135912,
      ê°ê°€ìƒê°ë¹„: 23440,
      ê¸°íƒ€íŒê´€ë¹„: 23655,
      ì˜ì—…ì´ìµ: 120419,
      ì˜ì—…ì™¸ì†ìµ: 55396,
      ì™¸í™˜ì†ìµ: 16230,
      ì„ ë¬¼í™˜ì†ìµ: 685,
      ê¸ˆìœµìƒí’ˆì†ìµ: 845,
      ì´ìì†ìµ: 4538,
      ë°°ë‹¹ìˆ˜ìµ: -271,
      ê¸°íƒ€ì†ìµ: 9703,
      ì§€ë¶„ë²•ì†ìµ: 17757,
      ê¸°ë¶€ê¸ˆ: 826,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 141346,
      ë²•ì¸ì„¸ë¹„ìš©: 35461,
      ë‹¹ê¸°ìˆœì´ìµ: 105885,
    },

    // 2024ë…„ ëˆ„ì 
    '2024_1Q_Year': {
      ë§¤ì¶œì•¡: 507029,
      ë§¤ì¶œì›ê°€: 174545,
      ë§¤ì¶œì´ì´ìµ: 332484,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 202273,
      ì¸ê±´ë¹„: 19658,
      ê´‘ê³ ì„ ì „ë¹„: 24097,
      ìˆ˜ìˆ˜ë£Œ: 118770,
      ê°ê°€ìƒê°ë¹„: 20565,
      ê¸°íƒ€íŒê´€ë¹„: 19183,
      ì˜ì—…ì´ìµ: 130211,
      ì˜ì—…ì™¸ì†ìµ: 21031,
      ì™¸í™˜ì†ìµ: 10008,
      ì„ ë¬¼í™˜ì†ìµ: 473,
      ê¸ˆìœµìƒí’ˆì†ìµ: 1941,
      ì´ìì†ìµ: 4736,
      ë°°ë‹¹ìˆ˜ìµ: 62,
      ê¸°íƒ€ì†ìµ: 2913,
      ì§€ë¶„ë²•ì†ìµ: 803,
      ê¸°ë¶€ê¸ˆ: 94,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 128159,
      ë²•ì¸ì„¸ë¹„ìš©: 31837,
      ë‹¹ê¸°ìˆœì´ìµ: 96322,
    },
    '2024_2Q_Year': {
      ë§¤ì¶œì•¡: 898501,
      ë§¤ì¶œì›ê°€: 294720,
      ë§¤ì¶œì´ì´ìµ: 603781,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 381771,
      ì¸ê±´ë¹„: 41660,
      ê´‘ê³ ì„ ì „ë¹„: 41052,
      ìˆ˜ìˆ˜ë£Œ: 221107,
      ê°ê°€ìƒê°ë¹„: 42103,
      ê¸°íƒ€íŒê´€ë¹„: 35849,
      ì˜ì—…ì´ìµ: 222010,
      ì˜ì—…ì™¸ì†ìµ: 37398,
      ì™¸í™˜ì†ìµ: 15547,
      ì„ ë¬¼í™˜ì†ìµ: 944,
      ê¸ˆìœµìƒí’ˆì†ìµ: 2689,
      ì´ìì†ìµ: 9581,
      ë°°ë‹¹ìˆ˜ìµ: 2207,
      ê¸°íƒ€ì†ìµ: 4326,
      ì§€ë¶„ë²•ì†ìµ: 1603,
      ê¸°ë¶€ê¸ˆ: 503,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 226115,
      ë²•ì¸ì„¸ë¹„ìš©: 55842,
      ë‹¹ê¸°ìˆœì´ìµ: 170273,
    },
    '2024_3Q_Year': {
      ë§¤ì¶œì•¡: 1349465,
      ë§¤ì¶œì›ê°€: 460761,
      ë§¤ì¶œì´ì´ìµ: 888704,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 558386,
      ì¸ê±´ë¹„: 61585,
      ê´‘ê³ ì„ ì „ë¹„: 60954,
      ìˆ˜ìˆ˜ë£Œ: 317570,
      ê°ê°€ìƒê°ë¹„: 65370,
      ê¸°íƒ€íŒê´€ë¹„: 52907,
      ì˜ì—…ì´ìµ: 330318,
      ì˜ì—…ì™¸ì†ìµ: 69888,
      ì™¸í™˜ì†ìµ: 20612,
      ì„ ë¬¼í™˜ì†ìµ: 1966,
      ê¸ˆìœµìƒí’ˆì†ìµ: 5157,
      ì´ìì†ìµ: 14068,
      ë°°ë‹¹ìˆ˜ìµ: 3295,
      ê¸°íƒ€ì†ìµ: 11678,
      ì§€ë¶„ë²•ì†ìµ: 10701,
      ê¸°ë¶€ê¸ˆ: 2413,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 335955,
      ë²•ì¸ì„¸ë¹„ìš©: 85881,
      ë‹¹ê¸°ìˆœì´ìµ: 250074,
    },
    '2024_Year': {
      ë§¤ì¶œì•¡: 1896010,
      ë§¤ì¶œì›ê°€: 649017,
      ë§¤ì¶œì´ì´ìµ: 1246993,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 796256,
      ì¸ê±´ë¹„: 84270,
      ê´‘ê³ ì„ ì „ë¹„: 93133,
      ìˆ˜ìˆ˜ë£Œ: 453482,
      ê°ê°€ìƒê°ë¹„: 88809,
      ê¸°íƒ€íŒê´€ë¹„: 76562,
      ì˜ì—…ì´ìµ: 450737,
      ì˜ì—…ì™¸ì†ìµ: 125284,
      ì™¸í™˜ì†ìµ: 36843,
      ì„ ë¬¼í™˜ì†ìµ: 2651,
      ê¸ˆìœµìƒí’ˆì†ìµ: 6002,
      ì´ìì†ìµ: 18606,
      ë°°ë‹¹ìˆ˜ìµ: 3024,
      ê¸°íƒ€ì†ìµ: 21379,
      ì§€ë¶„ë²•ì†ìµ: 28458,
      ê¸°ë¶€ê¸ˆ: 3239,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 477301,
      ë²•ì¸ì„¸ë¹„ìš©: 121341,
      ë‹¹ê¸°ìˆœì´ìµ: 355960,
    },

    // 2025ë…„ ë¶„ê¸° (3ê°œì›”)
    '2025_1Q': {
      ë§¤ì¶œì•¡: 505617,
      ë§¤ì¶œì›ê°€: 175882,
      ë§¤ì¶œì´ì´ìµ: 329735,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 206117,
      ì¸ê±´ë¹„: 21638,
      ê´‘ê³ ì„ ì „ë¹„: 24609,
      ìˆ˜ìˆ˜ë£Œ: 114788,
      ê°ê°€ìƒê°ë¹„: 24508,
      ê¸°íƒ€íŒê´€ë¹„: 20574,
      ì˜ì—…ì´ìµ: 123618,
      ì˜ì—…ì™¸ì†ìµ: 37983,
      ì™¸í™˜ì†ìµ: 21907,
      ì„ ë¬¼í™˜ì†ìµ: 3457,
      ê¸ˆìœµìƒí’ˆì†ìµ: 1129,
      ì´ìì†ìµ: 4360,
      ë°°ë‹¹ìˆ˜ìµ: 337,
      ê¸°íƒ€ì†ìµ: 6022,
      ì§€ë¶„ë²•ì†ìµ: 766,
      ê¸°ë¶€ê¸ˆ: 5,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 110663,
      ë²•ì¸ì„¸ë¹„ìš©: 28094,
      ë‹¹ê¸°ìˆœì´ìµ: 82569,
    },
    '2025_2Q': {
      ë§¤ì¶œì•¡: 378870,
      ë§¤ì¶œì›ê°€: 119965,
      ë§¤ì¶œì´ì´ìµ: 258905,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 174878,
      ì¸ê±´ë¹„: 20875,
      ê´‘ê³ ì„ ì „ë¹„: 19539,
      ìˆ˜ìˆ˜ë£Œ: 95162,
      ê°ê°€ìƒê°ë¹„: 22116,
      ê¸°íƒ€íŒê´€ë¹„: 17186,
      ì˜ì—…ì´ìµ: 84027,
      ì˜ì—…ì™¸ì†ìµ: 25837,
      ì™¸í™˜ì†ìµ: 10246,
      ì„ ë¬¼í™˜ì†ìµ: 5637,
      ê¸ˆìœµìƒí’ˆì†ìµ: -46,
      ì´ìì†ìµ: 3016,
      ë°°ë‹¹ìˆ˜ìµ: 37,
      ê¸°íƒ€ì†ìµ: 6118,
      ì§€ë¶„ë²•ì†ìµ: 828,
      ê¸°ë¶€ê¸ˆ: 0,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 86083,
      ë²•ì¸ì„¸ë¹„ìš©: 23444,
      ë‹¹ê¸°ìˆœì´ìµ: 62639,
    },
    '2025_3Q': {
      ë§¤ì¶œì•¡: 474257,
      ë§¤ì¶œì›ê°€: 165303,
      ë§¤ì¶œì´ì´ìµ: 308954,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 180936,
      ì¸ê±´ë¹„: 20266,
      ê´‘ê³ ì„ ì „ë¹„: 25032,
      ìˆ˜ìˆ˜ë£Œ: 93907,
      ê°ê°€ìƒê°ë¹„: 22262,
      ê¸°íƒ€íŒê´€ë¹„: 19469,
      ì˜ì—…ì´ìµ: 128018,
      ì˜ì—…ì™¸ì†ìµ: 23580,
      ì™¸í™˜ì†ìµ: 9435,
      ì„ ë¬¼í™˜ì†ìµ: -5393,
      ê¸ˆìœµìƒí’ˆì†ìµ: 668,
      ì´ìì†ìµ: 3480,
      ë°°ë‹¹ìˆ˜ìµ: 482,
      ê¸°íƒ€ì†ìµ: 5713,
      ì§€ë¶„ë²•ì†ìµ: 9117,
      ê¸°ë¶€ê¸ˆ: 78,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 135278,
      ë²•ì¸ì„¸ë¹„ìš©: 34583,
      ë‹¹ê¸°ìˆœì´ìµ: 100695,
    },
    '2025_4Q': {
      ë§¤ì¶œì•¡: 474257,
      ë§¤ì¶œì›ê°€: 165303,
      ë§¤ì¶œì´ì´ìµ: 308954,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 180936,
      ì¸ê±´ë¹„: 20266,
      ê´‘ê³ ì„ ì „ë¹„: 25032,
      ìˆ˜ìˆ˜ë£Œ: 93907,
      ê°ê°€ìƒê°ë¹„: 22262,
      ê¸°íƒ€íŒê´€ë¹„: 19469,
      ì˜ì—…ì´ìµ: 128018,
      ì˜ì—…ì™¸ì†ìµ: 23580,
      ì™¸í™˜ì†ìµ: 9435,
      ì„ ë¬¼í™˜ì†ìµ: -5393,
      ê¸ˆìœµìƒí’ˆì†ìµ: 668,
      ì´ìì†ìµ: 3480,
      ë°°ë‹¹ìˆ˜ìµ: 482,
      ê¸°íƒ€ì†ìµ: 5713,
      ì§€ë¶„ë²•ì†ìµ: 9117,
      ê¸°ë¶€ê¸ˆ: 78,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 135278,
      ë²•ì¸ì„¸ë¹„ìš©: 34583,
      ë‹¹ê¸°ìˆœì´ìµ: 100695,
    },

    // 2025ë…„ ëˆ„ì 
    '2025_1Q_Year': {
      ë§¤ì¶œì•¡: 505617,
      ë§¤ì¶œì›ê°€: 175882,
      ë§¤ì¶œì´ì´ìµ: 329735,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 206117,
      ì¸ê±´ë¹„: 21638,
      ê´‘ê³ ì„ ì „ë¹„: 24609,
      ìˆ˜ìˆ˜ë£Œ: 114788,
      ê°ê°€ìƒê°ë¹„: 24508,
      ê¸°íƒ€íŒê´€ë¹„: 20574,
      ì˜ì—…ì´ìµ: 123618,
      ì˜ì—…ì™¸ì†ìµ: 37983,
      ì™¸í™˜ì†ìµ: 21907,
      ì„ ë¬¼í™˜ì†ìµ: 3457,
      ê¸ˆìœµìƒí’ˆì†ìµ: 1129,
      ì´ìì†ìµ: 4360,
      ë°°ë‹¹ìˆ˜ìµ: 337,
      ê¸°íƒ€ì†ìµ: 6022,
      ì§€ë¶„ë²•ì†ìµ: 766,
      ê¸°ë¶€ê¸ˆ: 5,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 110663,
      ë²•ì¸ì„¸ë¹„ìš©: 28094,
      ë‹¹ê¸°ìˆœì´ìµ: 82569,
    },
    '2025_2Q_Year': {
      ë§¤ì¶œì•¡: 884487,
      ë§¤ì¶œì›ê°€: 295848,
      ë§¤ì¶œì´ì´ìµ: 588639,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 380996,
      ì¸ê±´ë¹„: 42515,
      ê´‘ê³ ì„ ì „ë¹„: 44148,
      ìˆ˜ìˆ˜ë£Œ: 209951,
      ê°ê°€ìƒê°ë¹„: 46623,
      ê¸°íƒ€íŒê´€ë¹„: 37759,
      ì˜ì—…ì´ìµ: 207643,
      ì˜ì—…ì™¸ì†ìµ: 63818,
      ì™¸í™˜ì†ìµ: 32153,
      ì„ ë¬¼í™˜ì†ìµ: 9095,
      ê¸ˆìœµìƒí’ˆì†ìµ: 1083,
      ì´ìì†ìµ: 7377,
      ë°°ë‹¹ìˆ˜ìµ: 373,
      ê¸°íƒ€ì†ìµ: 12138,
      ì§€ë¶„ë²•ì†ìµ: 1594,
      ê¸°ë¶€ê¸ˆ: 5,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 196746,
      ë²•ì¸ì„¸ë¹„ìš©: 51538,
      ë‹¹ê¸°ìˆœì´ìµ: 145208,
    },
    '2025_3Q_Year': {
      ë§¤ì¶œì•¡: 1358744,
      ë§¤ì¶œì›ê°€: 461149,
      ë§¤ì¶œì´ì´ìµ: 897595,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 561928,
      ì¸ê±´ë¹„: 62780,
      ê´‘ê³ ì„ ì „ë¹„: 69180,
      ìˆ˜ìˆ˜ë£Œ: 303857,
      ê°ê°€ìƒê°ë¹„: 68886,
      ê¸°íƒ€íŒê´€ë¹„: 57225,
      ì˜ì—…ì´ìµ: 335667,
      ì˜ì—…ì™¸ì†ìµ: 87398,
      ì™¸í™˜ì†ìµ: 41588,
      ì„ ë¬¼í™˜ì†ìµ: 3700,
      ê¸ˆìœµìƒí’ˆì†ìµ: 1752,
      ì´ìì†ìµ: 10856,
      ë°°ë‹¹ìˆ˜ìµ: 855,
      ê¸°íƒ€ì†ìµ: 17854,
      ì§€ë¶„ë²•ì†ìµ: 10711,
      ê¸°ë¶€ê¸ˆ: 83,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 332024,
      ë²•ì¸ì„¸ë¹„ìš©: 86121,
      ë‹¹ê¸°ìˆœì´ìµ: 245903,
    },
    '2025_Year': {
      ë§¤ì¶œì•¡: 1358744,
      ë§¤ì¶œì›ê°€: 461149,
      ë§¤ì¶œì´ì´ìµ: 897595,
      íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„: 561928,
      ì¸ê±´ë¹„: 62780,
      ê´‘ê³ ì„ ì „ë¹„: 69180,
      ìˆ˜ìˆ˜ë£Œ: 303857,
      ê°ê°€ìƒê°ë¹„: 68886,
      ê¸°íƒ€íŒê´€ë¹„: 57225,
      ì˜ì—…ì´ìµ: 335667,
      ì˜ì—…ì™¸ì†ìµ: 87398,
      ì™¸í™˜ì†ìµ: 41588,
      ì„ ë¬¼í™˜ì†ìµ: 3700,
      ê¸ˆìœµìƒí’ˆì†ìµ: 1752,
      ì´ìì†ìµ: 10856,
      ë°°ë‹¹ìˆ˜ìµ: 855,
      ê¸°íƒ€ì†ìµ: 17854,
      ì§€ë¶„ë²•ì†ìµ: 10711,
      ê¸°ë¶€ê¸ˆ: 83,
      ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ: 332024,
      ë²•ì¸ì„¸ë¹„ìš©: 86121,
      ë‹¹ê¸°ìˆœì´ìµ: 245903,
    },
  };

  // ============================================
  // ì¬ë¬´ìƒíƒœí‘œ ë°ì´í„° - ì „ë…„ê¸°ë§ vs ë‹¹ê¸°ë§
  // ============================================
  // ì¬ë¬´ìƒíƒœí‘œ ë°ì´í„° (ì„±ê²©ë³„ ë¶„ë¥˜ - ìœ ë™/ë¹„ìœ ë™ í†µí•©)
  const balanceSheetData = {
    // 2024ë…„ ì—°ê²° BS (2024_BS.csv ê¸°ë°˜, ë‹¨ìœ„: ë°±ë§Œì›)
    '2024_1Q': {
      í˜„ê¸ˆì„±ìì‚°: 334707,
      ê¸ˆìœµìƒí’ˆ: 32034,
      ë§¤ì¶œì±„ê¶Œ: 82369,
      ì¬ê³ ìì‚°: 323836,
      ê´€ê³„ê¸°ì—…íˆ¬ì: 633124,
      ìœ ë¬´í˜•ìì‚°: 327883,
      ì‚¬ìš©ê¶Œìì‚°: 213602,
      ê¸°íƒ€ìì‚°: 109815,
      ìì‚°ì´ê³„: 2057370,
      ì°¨ì…ê¸ˆ: 73262,
      ë§¤ì…ì±„ë¬´: 75896,
      ë¯¸ì§€ê¸‰ê¸ˆ: 95705,
      ë¦¬ìŠ¤ë¶€ì±„: 163946,
      ë³´ì¦ê¸ˆ: 16360,
      ê¸°íƒ€ë¶€ì±„: 282478,
      ë¶€ì±„ì´ê³„: 707649,
      ìë³¸ê¸ˆ: 3831,
      ìë³¸ì‰ì—¬ê¸ˆ: 317545,
      ê¸°íƒ€ìë³¸: -21519,
      ì´ìµì‰ì—¬ê¸ˆ: 1018879,
      ë¹„ì§€ë°°ì§€ë¶„: 30985,
      ìë³¸ì´ê³„: 1349721,
    },
    '2024_2Q': {
      í˜„ê¸ˆì„±ìì‚°: 220611,
      ê¸ˆìœµìƒí’ˆ: 18747,
      ë§¤ì¶œì±„ê¶Œ: 67859,
      ì¬ê³ ìì‚°: 292899,
      ê´€ê³„ê¸°ì—…íˆ¬ì: 632510,
      ìœ ë¬´í˜•ìì‚°: 384106,
      ì‚¬ìš©ê¶Œìì‚°: 210463,
      ê¸°íƒ€ìì‚°: 99180,
      ìì‚°ì´ê³„: 1926377,
      ì°¨ì…ê¸ˆ: 820,
      ë§¤ì…ì±„ë¬´: 62956,
      ë¯¸ì§€ê¸‰ê¸ˆ: 34040,
      ë¦¬ìŠ¤ë¶€ì±„: 160758,
      ë³´ì¦ê¸ˆ: 16225,
      ê¸°íƒ€ë¶€ì±„: 239442,
      ë¶€ì±„ì´ê³„: 514242,
      ìë³¸ê¸ˆ: 3831,
      ìë³¸ì‰ì—¬ê¸ˆ: 317545,
      ê¸°íƒ€ìë³¸: -33162,
      ì´ìµì‰ì—¬ê¸ˆ: 1092725,
      ë¹„ì§€ë°°ì§€ë¶„: 31196,
      ìë³¸ì´ê³„: 1412135,
    },
    '2024_3Q': {
      í˜„ê¸ˆì„±ìì‚°: 190422,
      ê¸ˆìœµìƒí’ˆ: 17954,
      ë§¤ì¶œì±„ê¶Œ: 135245,
      ì¬ê³ ìì‚°: 361737,
      ê´€ê³„ê¸°ì—…íˆ¬ì: 634781,
      ìœ ë¬´í˜•ìì‚°: 441828,
      ì‚¬ìš©ê¶Œìì‚°: 207368,
      ê¸°íƒ€ìì‚°: 150141,
      ìì‚°ì´ê³„: 2139478,
      ì°¨ì…ê¸ˆ: 86820,
      ë§¤ì…ì±„ë¬´: 130612,
      ë¯¸ì§€ê¸‰ê¸ˆ: 37911,
      ë¦¬ìŠ¤ë¶€ì±„: 158831,
      ë³´ì¦ê¸ˆ: 16125,
      ê¸°íƒ€ë¶€ì±„: 224490,
      ë¶€ì±„ì´ê³„: 654790,
      ìë³¸ê¸ˆ: 3831,
      ìë³¸ì‰ì—¬ê¸ˆ: 317545,
      ê¸°íƒ€ìë³¸: -40262,
      ì´ìµì‰ì—¬ê¸ˆ: 1176364,
      ë¹„ì§€ë°°ì§€ë¶„: 27209,
      ìë³¸ì´ê³„: 1484687,
    },
    // 2025ë…„ ì—°ê²° BS (2025_BS.csv ê¸°ë°˜, ë‹¨ìœ„: ë°±ë§Œì›)
    '2025_1Q': {
      í˜„ê¸ˆì„±ìì‚°: 164044,
      ê¸ˆìœµìƒí’ˆ: 10966,
      ë§¤ì¶œì±„ê¶Œ: 91239,
      ì¬ê³ ìì‚°: 314052,
      ê´€ê³„ê¸°ì—…íˆ¬ì: 651745,
      ìœ ë¬´í˜•ìì‚°: 713433,
      ì‚¬ìš©ê¶Œìì‚°: 198220,
      ê¸°íƒ€ìì‚°: 114250,
      ìì‚°ì´ê³„: 2257950,
      ì°¨ì…ê¸ˆ: 76470,
      ë§¤ì…ì±„ë¬´: 81968,
      ë¯¸ì§€ê¸‰ê¸ˆ: 100026,
      ë¦¬ìŠ¤ë¶€ì±„: 151882,
      ë³´ì¦ê¸ˆ: 18817,
      ê¸°íƒ€ë¶€ì±„: 234811,
      ë¶€ì±„ì´ê³„: 663974,
      ìë³¸ê¸ˆ: 3831,
      ìë³¸ì‰ì—¬ê¸ˆ: 317545,
      ê¸°íƒ€ìë³¸: -43459,
      ì´ìµì‰ì—¬ê¸ˆ: 1302260,
      ë¹„ì§€ë°°ì§€ë¶„: 13799,
      ìë³¸ì´ê³„: 1593976,
    },
    '2025_2Q': {
      í˜„ê¸ˆì„±ìì‚°: 126440,
      ê¸ˆìœµìƒí’ˆ: 11012,
      ë§¤ì¶œì±„ê¶Œ: 61178,
      ì¬ê³ ìì‚°: 293350,
      ê´€ê³„ê¸°ì—…íˆ¬ì: 650955,
      ìœ ë¬´í˜•ìì‚°: 702103,
      ì‚¬ìš©ê¶Œìì‚°: 184171,
      ê¸°íƒ€ìì‚°: 121492,
      ìì‚°ì´ê³„: 2150700,
      ì°¨ì…ê¸ˆ: 32157,
      ë§¤ì…ì±„ë¬´: 68454,
      ë¯¸ì§€ê¸‰ê¸ˆ: 28936,
      ë¦¬ìŠ¤ë¶€ì±„: 142100,
      ë³´ì¦ê¸ˆ: 19565,
      ê¸°íƒ€ë¶€ì±„: 211731,
      ë¶€ì±„ì´ê³„: 502944,
      ìë³¸ê¸ˆ: 3831,
      ìë³¸ì‰ì—¬ê¸ˆ: 317545,
      ê¸°íƒ€ìë³¸: -51346,
      ì´ìµì‰ì—¬ê¸ˆ: 1364602,
      ë¹„ì§€ë°°ì§€ë¶„: 13124,
      ìë³¸ì´ê³„: 1647756,
    },
    '2025_3Q': {
      í˜„ê¸ˆì„±ìì‚°: 208285,
      ê¸ˆìœµìƒí’ˆ: 36645,
      ë§¤ì¶œì±„ê¶Œ: 159109,
      ì¬ê³ ìì‚°: 414026,
      ê´€ê³„ê¸°ì—…íˆ¬ì: 653157,
      ìœ ë¬´í˜•ìì‚°: 703080,
      ì‚¬ìš©ê¶Œìì‚°: 186155,
      ê¸°íƒ€ìì‚°: 140206,
      ìì‚°ì´ê³„: 2500662,
      ì°¨ì…ê¸ˆ: 160605,
      ë§¤ì…ì±„ë¬´: 158517,
      ë¯¸ì§€ê¸‰ê¸ˆ: 36728,
      ë¦¬ìŠ¤ë¶€ì±„: 139760,
      ë³´ì¦ê¸ˆ: 18953,
      ê¸°íƒ€ë¶€ì±„: 235599,
      ë¶€ì±„ì´ê³„: 750162,
      ìë³¸ê¸ˆ: 3831,
      ìë³¸ì‰ì—¬ê¸ˆ: 317545,
      ê¸°íƒ€ìë³¸: -50132,
      ì´ìµì‰ì—¬ê¸ˆ: 1463247,
      ë¹„ì§€ë°°ì§€ë¶„: 16009,
      ìë³¸ì´ê³„: 1750500,
    },
    '2025_4Q': {
      í˜„ê¸ˆì„±ìì‚°: 208285,
      ê¸ˆìœµìƒí’ˆ: 36645,
      ë§¤ì¶œì±„ê¶Œ: 159109,
      ì¬ê³ ìì‚°: 414026,
      ê´€ê³„ê¸°ì—…íˆ¬ì: 653157,
      ìœ ë¬´í˜•ìì‚°: 703080,
      ì‚¬ìš©ê¶Œìì‚°: 186155,
      ê¸°íƒ€ìì‚°: 140206,
      ìì‚°ì´ê³„: 2500662,
      ì°¨ì…ê¸ˆ: 160605,
      ë§¤ì…ì±„ë¬´: 158517,
      ë¯¸ì§€ê¸‰ê¸ˆ: 36728,
      ë¦¬ìŠ¤ë¶€ì±„: 139760,
      ë³´ì¦ê¸ˆ: 18953,
      ê¸°íƒ€ë¶€ì±„: 235599,
      ë¶€ì±„ì´ê³„: 750162,
      ìë³¸ê¸ˆ: 3831,
      ìë³¸ì‰ì—¬ê¸ˆ: 317545,
      ê¸°íƒ€ìë³¸: -50132,
      ì´ìµì‰ì—¬ê¸ˆ: 1463247,
      ë¹„ì§€ë°°ì§€ë¶„: 16009,
      ìë³¸ì´ê³„: 1750500,
    },
    '2024_4Q': {
      // ìì‚° (ì„±ê²©ë³„)
      í˜„ê¸ˆì„±ìì‚°: 119833,
      ê¸ˆìœµìƒí’ˆ: 19479,      // ìœ ë™ 6,388 + ë¹„ìœ ë™ 13,091
      ë§¤ì¶œì±„ê¶Œ: 133826,
      ì¬ê³ ìì‚°: 324992,
      ê´€ê³„ê¸°ì—…íˆ¬ì: 652474,
      ìœ ë¬´í˜•ìì‚°: 714996,   // ìœ í˜• 501,307 + íˆ¬ìë¶€ë™ì‚° 0 + ë¬´í˜• 213,689
      ì‚¬ìš©ê¶Œìì‚°: 207683,
      ê¸°íƒ€ìì‚°: 112622,     // ìœ ë™ê¸°íƒ€ 51,755 + ë¹„ìœ ë™ê¸°íƒ€ 60,867
      ìì‚°ì´ê³„: 2285905,
      // ë¶€ì±„ (ì„±ê²©ë³„)
      ì°¨ì…ê¸ˆ: 145635,       // ë‹¨ê¸° 145,635 + ì¥ê¸° 0
      ë§¤ì…ì±„ë¬´: 102685,
      ë¯¸ì§€ê¸‰ê¸ˆ: 41982,
      ë¦¬ìŠ¤ë¶€ì±„: 215428,     // ìœ ë™ 57,979 + ë¹„ìœ ë™ 157,449
      ë³´ì¦ê¸ˆ: 5692,
      ê¸°íƒ€ë¶€ì±„: 197185,     // ìœ ë™ê¸°íƒ€ 173,828 + ë¹„ìœ ë™ê¸°íƒ€ 23,355
      ë¶€ì±„ì´ê³„: 708607,
      // ìë³¸
      ìë³¸ê¸ˆ: 3831,
      ìë³¸ì‰ì—¬ê¸ˆ: 317545,
      ê¸°íƒ€ìë³¸: -42530,
      ì´ìµì‰ì—¬ê¸ˆ: 1283355,
      ë¹„ì§€ë°°ì§€ë¶„: 15098,
      ìë³¸ì´ê³„: 1577298,
    },
  };

  // ============================================
  // ê¸ˆìœµìƒí’ˆí‰ê°€ ë°ì´í„°
  // ============================================
  const financialInstrumentsData = {
    '2025_4Q': {
      // ë‹¹ê¸°ì†ìµ-ê³µì •ê°€ì¹˜ ì¸¡ì • ê¸ˆìœµìì‚°
      FVPLê¸ˆìœµìì‚°: 0,
      // ê¸°íƒ€í¬ê´„ì†ìµ-ê³µì •ê°€ì¹˜ ì¸¡ì • ê¸ˆìœµìì‚°
      FVOCIê¸ˆìœµìì‚°: 0,
      // ìƒê°í›„ì›ê°€ ì¸¡ì • ê¸ˆìœµìì‚°
      ACê¸ˆìœµìì‚°: 0,
      // íŒŒìƒìƒí’ˆìì‚°
      íŒŒìƒìƒí’ˆìì‚°: 0,
      // ê¸ˆìœµë¶€ì±„
      ë‹¹ê¸°ì†ìµì¸ì‹ê¸ˆìœµë¶€ì±„: 0,
      ìƒê°í›„ì›ê°€ê¸ˆìœµë¶€ì±„: 0,
      íŒŒìƒìƒí’ˆë¶€ì±„: 0,
      // í‰ê°€ì†ìµ
      FVPLí‰ê°€ì†ìµ: 0,
      FVOCIí‰ê°€ì†ìµ: 0,
      íŒŒìƒìƒí’ˆí‰ê°€ì†ìµ: 0,
    },
    '2024_4Q': {
      FVPLê¸ˆìœµìì‚°: 0,
      FVOCIê¸ˆìœµìì‚°: 0,
      ACê¸ˆìœµìì‚°: 0,
      íŒŒìƒìƒí’ˆìì‚°: 0,
      ë‹¹ê¸°ì†ìµì¸ì‹ê¸ˆìœµë¶€ì±„: 0,
      ìƒê°í›„ì›ê°€ê¸ˆìœµë¶€ì±„: 0,
      íŒŒìƒìƒí’ˆë¶€ì±„: 0,
      FVPLí‰ê°€ì†ìµ: 0,
      FVOCIí‰ê°€ì†ìµ: 0,
      íŒŒìƒìƒí’ˆí‰ê°€ì†ìµ: 0,
    },
  };

  // ============================================
  // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
  // ============================================
  const formatNumber = (num) => {
    if (num === 0 || num === undefined || num === null) return '-';
    return new Intl.NumberFormat('ko-KR').format(num);
  };

  const calculateYoY = (current, previous) => {
    if (!previous || previous === 0) return '-';
    const change = ((current - previous) / Math.abs(previous)) * 100;
    return change.toFixed(1);
  };

  const calculateDiff = (current, previous) => {
    if (current === 0 && previous === 0) return 0;
    return current - previous;
  };

  // ============================================
  // íƒ­ ì»´í¬ë„ŒíŠ¸
  // ============================================
  const tabs = [
    { id: 'summary', label: 'ì „ì²´ìš”ì•½', icon: 'ğŸ“Š' },
    { id: 'income', label: 'ì†ìµê³„ì‚°ì„œ', icon: 'ğŸ“ˆ' },
    { id: 'balance', label: 'ì¬ë¬´ìƒíƒœí‘œ', icon: 'ğŸ’°' },
  ];

  // ============================================
  // ì „ì²´ìš”ì•½ íƒ­ ë Œë”ë§
  // ============================================
  const renderSummaryTab = () => {
    // ì†ìµ ìš”ì•½ ì¹´ë“œ ë°ì´í„° (ì–µì› ë‹¨ìœ„, ì„ íƒëœ ë¶„ê¸°ê¹Œì§€ ëˆ„ì  ê¸°ì¤€)
    const selectedYearKey = getPeriodKey(selectedPeriod, 'year');
    const prevYearKey = getPeriodKey(selectedPeriod, 'prev_year') || '2024_Year';
    const incomeCards = [
      { title: 'ë§¤ì¶œì•¡', value: Math.round((incomeStatementData[selectedYearKey]?.ë§¤ì¶œì•¡ || 0) / 100), prevValue: Math.round((incomeStatementData[prevYearKey]?.ë§¤ì¶œì•¡ || 0) / 100), iconColor: 'bg-blue-500' },
      { title: 'ì˜ì—…ì´ìµ', value: Math.round((incomeStatementData[selectedYearKey]?.ì˜ì—…ì´ìµ || 0) / 100), prevValue: Math.round((incomeStatementData[prevYearKey]?.ì˜ì—…ì´ìµ || 0) / 100), iconColor: 'bg-emerald-500' },
      { title: 'ë‹¹ê¸°ìˆœì´ìµ', value: Math.round((incomeStatementData[selectedYearKey]?.ë‹¹ê¸°ìˆœì´ìµ || 0) / 100), prevValue: Math.round((incomeStatementData[prevYearKey]?.ë‹¹ê¸°ìˆœì´ìµ || 0) / 100), iconColor: 'bg-violet-500' },
    ];

    // ì¬ë¬´ìƒíƒœ ìš”ì•½ ì¹´ë“œ ë°ì´í„° (ì–µì› ë‹¨ìœ„, ì„ íƒëœ ë¶„ê¸° ê¸°ë§ ê¸°ì¤€)
    const balanceCards = [
      { title: 'ìì‚°ì´ê³„', value: Math.round((balanceSheetData[bsCurrentPeriod]?.ìì‚°ì´ê³„ || 0) / 100), prevValue: Math.round((balanceSheetData[bsPrevPeriod]?.ìì‚°ì´ê³„ || 0) / 100), iconColor: 'bg-amber-500' },
      { title: 'ë¶€ì±„ì´ê³„', value: Math.round((balanceSheetData[bsCurrentPeriod]?.ë¶€ì±„ì´ê³„ || 0) / 100), prevValue: Math.round((balanceSheetData[bsPrevPeriod]?.ë¶€ì±„ì´ê³„ || 0) / 100), iconColor: 'bg-rose-500' },
      { title: 'ìë³¸ì´ê³„', value: Math.round((balanceSheetData[bsCurrentPeriod]?.ìë³¸ì´ê³„ || 0) / 100), prevValue: Math.round((balanceSheetData[bsPrevPeriod]?.ìë³¸ì´ê³„ || 0) / 100), iconColor: 'bg-cyan-500' },
    ];

    // ì¡°ë‹¨ìœ„ í¬ë§· í•¨ìˆ˜ (ì–µì› ë‹¨ìœ„ ì…ë ¥) - ìˆ«ìì™€ ë‹¨ìœ„ ë¶„ë¦¬ ë°˜í™˜
    const formatTrilBilSummary = (valueInBil) => {
      if (valueInBil === 0 || valueInBil === undefined || valueInBil === null) return { number: '-', unit: '' };
      const absValue = Math.abs(valueInBil);
      const sign = valueInBil < 0 ? '-' : '';
      
      if (absValue >= 10000) {
        const tril = Math.floor(absValue / 10000);
        const bil = Math.round(absValue % 10000);
        return { number: `${sign}${tril}ì¡° ${formatNumber(bil)}`, unit: 'ì–µì›' };
      }
      return { number: `${sign}${formatNumber(Math.round(absValue))}`, unit: 'ì–µì›' };
    };

    // ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜
    const renderCard = (card, idx) => {
      const change = card.prevValue !== 0 
        ? ((card.value - card.prevValue) / Math.abs(card.prevValue) * 100).toFixed(1) 
        : 0;
      const isPositive = parseFloat(change) >= 0;
      const formatted = formatTrilBilSummary(card.value);
      
      return (
        <div key={idx} className="bg-white rounded-lg border border-zinc-200 shadow-sm p-4 hover:shadow-md transition-shadow duration-200">
          <div className="flex items-center gap-2 mb-2">
            <span className={`w-2 h-2 rounded-full ${card.iconColor}`}></span>
            <span className="text-xs font-medium text-zinc-500 uppercase tracking-wide">{card.title}</span>
          </div>
          <div className="flex items-baseline gap-1">
            <span className="text-2xl font-bold text-zinc-900">{formatted.number}</span>
            <span className="text-sm font-normal text-zinc-400">{formatted.unit}</span>
          </div>
          <div className={`text-xs font-semibold mt-1 ${isPositive ? 'text-emerald-600' : 'text-rose-600'}`}>
            {change != 0 ? `${isPositive ? 'â–²' : 'â–¼'} ${Math.abs(parseFloat(change))}% YoY` : '-'}
          </div>
        </div>
      );
    };

    return (
      <div className="space-y-4">
        {/* ì†ìµ ìš”ì•½ ì„¹ì…˜ */}
        <div>
          <h3 className="text-sm font-semibold text-zinc-700 mb-2 flex items-center gap-2">
            <span className="w-1 h-4 bg-blue-500 rounded"></span>
            ì†ìµ ìš”ì•½
          </h3>
          <div className="grid grid-cols-3 gap-3">
            {incomeCards.map((card, idx) => renderCard(card, idx))}
          </div>
        </div>

        {/* ì¬ë¬´ìƒíƒœ ìš”ì•½ ì„¹ì…˜ */}
        <div>
          <h3 className="text-sm font-semibold text-zinc-700 mb-2 flex items-center gap-2">
            <span className="w-1 h-4 bg-amber-500 rounded"></span>
            ì¬ë¬´ìƒíƒœ ìš”ì•½
          </h3>
          <div className="grid grid-cols-3 gap-3">
            {balanceCards.map((card, idx) => renderCard(card, idx))}
          </div>
        </div>

        {/* AI ë¶„ì„ ì„¹ì…˜ */}
        <div>
          <h3 className="text-sm font-semibold text-zinc-700 mb-2 flex items-center gap-2">
            <span className="w-1 h-4 bg-gradient-to-b from-blue-500 to-violet-500 rounded"></span>
            AI ë¶„ì„
          </h3>
          <div className="bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-lg p-5 text-white shadow-lg">
            <div className="flex items-center gap-2 mb-4">
              <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-violet-500 flex items-center justify-center shadow-md">
                <span className="text-white text-xs font-bold">AI</span>
              </div>
              <div>
                <div className="text-sm font-semibold">F&F 2025ë…„ ì—°ê°„ ì¬ë¬´ ì¢…í•© ë¶„ì„</div>
                <div className="text-xs text-zinc-400">ìˆ˜ìµì„± Â· ì•ˆì •ì„± Â· ë¦¬ìŠ¤í¬ Â· ì•¡ì…˜í”Œëœ</div>
              </div>
            </div>
            
            {/* í•µì‹¬ ì§€í‘œ ìš”ì•½ */}
            <div className="grid grid-cols-4 gap-2 mb-4 p-3 bg-white/5 rounded-lg border border-white/10">
              <div className="text-center">
                <div className="text-[10px] text-zinc-400 mb-0.5">ì˜ì—…ì´ìµë¥ </div>
                <div className="text-sm font-bold text-emerald-400">24.7%</div>
                <div className="text-[10px] text-emerald-400">+0.9%p</div>
              </div>
              <div className="text-center border-l border-white/10">
                <div className="text-[10px] text-zinc-400 mb-0.5">ìˆœì´ìµë¥ </div>
                <div className="text-sm font-bold text-blue-400">18.1%</div>
                <div className="text-[10px] text-rose-400">-0.7%p</div>
              </div>
              <div className="text-center border-l border-white/10">
                <div className="text-[10px] text-zinc-400 mb-0.5">ë¶€ì±„ë¹„ìœ¨</div>
                <div className="text-sm font-bold text-amber-400">48.0%</div>
                <div className="text-[10px] text-emerald-400">ì•ˆì •</div>
              </div>
              <div className="text-center border-l border-white/10">
                <div className="text-[10px] text-zinc-400 mb-0.5">ROE</div>
                <div className="text-sm font-bold text-violet-400">12.9%</div>
                <div className="text-[10px] text-rose-400">-5.7%p</div>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-3 mb-4">
              {/* ì£¼ìš” ì¸ì‚¬ì´íŠ¸ */}
              <div className="p-3 bg-white/5 rounded-lg border border-white/10">
                <div className="flex items-center gap-2 mb-2">
                  <span className="w-2 h-2 rounded-full bg-emerald-400"></span>
                  <span className="text-xs font-semibold text-emerald-400">ì£¼ìš” ì¸ì‚¬ì´íŠ¸</span>
                </div>
                <ul className="text-xs text-zinc-300 space-y-1.5">
                  <li className="flex items-start gap-1.5">
                    <span className="text-emerald-400 mt-0.5">â€¢</span>
                    <span><strong className="text-white">ìˆ˜ìµì„± ê°œì„ :</strong> ë§¤ì¶œ 28% ê°ì†Œì—ë„ ì˜ì—…ì´ìµë¥  24.7%ë¡œ 0.9%p ìƒìŠ¹, ë¹„ìš© íš¨ìœ¨í™” ì„±ê³µ</span>
                  </li>
                  <li className="flex items-start gap-1.5">
                    <span className="text-emerald-400 mt-0.5">â€¢</span>
                    <span><strong className="text-white">í˜„ê¸ˆì°½ì¶œë ¥ ê°•í™”:</strong> í˜„ê¸ˆì„±ìì‚° 2,072ì–µì›ìœ¼ë¡œ 73% ì¦ê°€, ìœ ë™ì„± ëŒ€í­ ê°œì„ </span>
                  </li>
                  <li className="flex items-start gap-1.5">
                    <span className="text-emerald-400 mt-0.5">â€¢</span>
                    <span><strong className="text-white">ë¬´ì°¨ì… ê²½ì˜:</strong> êµ­ë‚´ë²•ì¸ ì°¨ì…ê¸ˆ ì „ì•¡ ìƒí™˜, ì¬ë¬´ê±´ì „ì„± ê°•í™”</span>
                  </li>
                </ul>
              </div>

              {/* ë¦¬ìŠ¤í¬ ë¶„ì„ */}
              <div className="p-3 bg-white/5 rounded-lg border border-white/10">
                <div className="flex items-center gap-2 mb-2">
                  <span className="w-2 h-2 rounded-full bg-rose-400"></span>
                  <span className="text-xs font-semibold text-rose-400">ë¦¬ìŠ¤í¬ ë¶„ì„</span>
                </div>
                <ul className="text-xs text-zinc-300 space-y-1.5">
                  <li className="flex items-start gap-1.5">
                    <span className="text-rose-400 mt-0.5">âš </span>
                    <span><strong className="text-white">ë§¤ì¶œ ì—­ì„±ì¥:</strong> ì „ë…„ëŒ€ë¹„ 28.3% ê°ì†Œ, ì¤‘êµ­Â·êµ­ë‚´ ëª¨ë‘ ë¶€ì§„. ì†Œë¹„ ì‹¬ë¦¬ ìœ„ì¶• ì˜í–¥</span>
                  </li>
                  <li className="flex items-start gap-1.5">
                    <span className="text-rose-400 mt-0.5">âš </span>
                    <span><strong className="text-white">ì¬ê³  ë¶€ë‹´:</strong> ì¬ê³ ìì‚° 42.9% ê¸‰ì¦(5,707ì–µì›), ì¬ê³ íšŒì „ìœ¨ ì•…í™” ìš°ë ¤</span>
                  </li>
                  <li className="flex items-start gap-1.5">
                    <span className="text-rose-400 mt-0.5">âš </span>
                    <span><strong className="text-white">ì¤‘êµ­ ë¦¬ìŠ¤í¬:</strong> ì¤‘êµ­ë²•ì¸ ì°¨ì…ê¸ˆ 1,606ì–µì›, í™˜ìœ¨ ë° ì •ì±… ë³€ë™ì„± ë…¸ì¶œ</span>
                  </li>
                </ul>
              </div>
            </div>

            {/* ì•¡ì…˜ í”Œëœ */}
            <div className="p-3 bg-gradient-to-r from-blue-500/20 to-violet-500/20 rounded-lg border border-blue-400/30">
              <div className="flex items-center gap-2 mb-2">
                <span className="w-2 h-2 rounded-full bg-violet-400"></span>
                <span className="text-xs font-semibold text-violet-400">ì „ëµì  ì•¡ì…˜ í”Œëœ</span>
              </div>
              <div className="grid grid-cols-3 gap-3">
                <div className="p-2 bg-white/5 rounded">
                  <div className="flex items-center gap-1.5 mb-1">
                    <span className="text-blue-400 text-sm">ğŸ“ˆ</span>
                    <span className="text-[11px] font-semibold text-blue-400">ì„±ì¥ ì „ëµ</span>
                  </div>
                  <p className="text-[10px] text-zinc-300 leading-relaxed">
                    MLB ë¸Œëœë“œ ê¸€ë¡œë²Œ í™•ì¥ ê°€ì†í™”, ë™ë‚¨ì•„Â·ìœ ëŸ½ ì‹œì¥ ì§„ì¶œ í†µí•œ ì¤‘êµ­ ì˜ì¡´ë„ ë¶„ì‚°
                  </p>
                </div>
                <div className="p-2 bg-white/5 rounded">
                  <div className="flex items-center gap-1.5 mb-1">
                    <span className="text-amber-400 text-sm">ğŸ“¦</span>
                    <span className="text-[11px] font-semibold text-amber-400">ìš´ì˜ íš¨ìœ¨í™”</span>
                  </div>
                  <p className="text-[10px] text-zinc-300 leading-relaxed">
                    ì¬ê³ íšŒì „ìœ¨ ê°œì„  ìœ„í•œ í”„ë¡œëª¨ì…˜ í™•ëŒ€, ì‹œì¦Œë³„ ë°œì£¼ëŸ‰ ìµœì í™” ë° SCM ê³ ë„í™”
                  </p>
                </div>
                <div className="p-2 bg-white/5 rounded">
                  <div className="flex items-center gap-1.5 mb-1">
                    <span className="text-emerald-400 text-sm">ğŸ’°</span>
                    <span className="text-[11px] font-semibold text-emerald-400">ìë³¸ í™œìš©</span>
                  </div>
                  <p className="text-[10px] text-zinc-300 leading-relaxed">
                    í’ë¶€í•œ í˜„ê¸ˆ(2,072ì–µ)ì„ í™œìš©í•œ ì‹ ê·œ ë¸Œëœë“œ ì¸ìˆ˜ ë˜ëŠ” ì£¼ì£¼í™˜ì› ì •ì±… ê°•í™” ê²€í† 
                  </p>
                </div>
              </div>
            </div>

            <div className="mt-4 pt-3 border-t border-white/10 flex items-center justify-between">
              <span className="text-[10px] text-zinc-500">AI ë¶„ì„ì€ ì°¸ê³ ìš©ì´ë©° íˆ¬ì ì¡°ì–¸ì´ ì•„ë‹™ë‹ˆë‹¤</span>
              <span className="text-[10px] text-zinc-500">2025ë…„ ì—°ê°„ ì‹¤ì  ê¸°ì¤€</span>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // ============================================
  // ì†ìµê³„ì‚°ì„œ íƒ­ ë Œë”ë§
  // ============================================
  const renderIncomeTab = () => {
    // ë¹„ìœ¨ ê³„ì‚° í•¨ìˆ˜
    const calcRate = (numerator, denominator) => {
      if (!denominator || denominator === 0) return '-';
      return ((numerator / denominator) * 100).toFixed(1) + '%';
    };

    // ì¦ê°ë¥  ê³„ì‚° (percentage point ìš©)
    const calcRateDiff = (current, prev) => {
      if (current === '-' || prev === '-') return '-';
      const currNum = parseFloat(current);
      const prevNum = parseFloat(prev);
      if (isNaN(currNum) || isNaN(prevNum)) return '-';
      const diff = currNum - prevNum;
      return (diff >= 0 ? '+' : '') + diff.toFixed(1) + '%p';
    };

    // ë²•ì¸ë³„ ë°ì´í„° (ì„ íƒëœ ê³¼ëª©ì— ë”°ë¼) - ë¶„ê¸° ë° ëˆ„ì 
    // ì£¼ì˜: ë²•ì¸ë³„ ë°ì´í„°ëŠ” ì—°ê²°ì¡°ì • ì „ ë²•ì¸ë³„ í•©ì‚° ê¸°ì¤€ (ì—°ê°„ ëˆ„ì )
    const entityData = {
      'ë§¤ì¶œì•¡': {
        '2024_4Q': { 'OC(êµ­ë‚´)': 1517994, 'ì¤‘êµ­': 857840, 'í™ì½©': 75034, 'ê¸°íƒ€': 12749 },
        '2025_4Q': { 'OC(êµ­ë‚´)': 1214833, 'ì¤‘êµ­': 713162, 'í™ì½©': 53313, 'ê¸°íƒ€': 5138 },
        '2024_Year': { 'OC(êµ­ë‚´)': 1517994, 'ì¤‘êµ­': 857840, 'í™ì½©': 75034, 'ê¸°íƒ€': 12749 },
        '2025_Year': { 'OC(êµ­ë‚´)': 1214833, 'ì¤‘êµ­': 713162, 'í™ì½©': 53313, 'ê¸°íƒ€': 5138 },
      },
      'ë§¤ì¶œì›ê°€': {
        '2024_4Q': { 'OC(êµ­ë‚´)': 543612, 'ì¤‘êµ­': 664165, 'í™ì½©': 32066, 'ê¸°íƒ€': 27230 },
        '2025_4Q': { 'OC(êµ­ë‚´)': 449911, 'ì¤‘êµ­': 547506, 'í™ì½©': 24678, 'ê¸°íƒ€': 8536 },
        '2024_Year': { 'OC(êµ­ë‚´)': 543612, 'ì¤‘êµ­': 664165, 'í™ì½©': 32066, 'ê¸°íƒ€': 27230 },
        '2025_Year': { 'OC(êµ­ë‚´)': 449911, 'ì¤‘êµ­': 547506, 'í™ì½©': 24678, 'ê¸°íƒ€': 8536 },
      },
      'ë§¤ì¶œì´ì´ìµ': {
        '2024_4Q': { 'OC(êµ­ë‚´)': 974381, 'ì¤‘êµ­': 193674, 'í™ì½©': 42968, 'ê¸°íƒ€': -14481 },
        '2025_4Q': { 'OC(êµ­ë‚´)': 764921, 'ì¤‘êµ­': 165656, 'í™ì½©': 28634, 'ê¸°íƒ€': -3397 },
        '2024_Year': { 'OC(êµ­ë‚´)': 974381, 'ì¤‘êµ­': 193674, 'í™ì½©': 42968, 'ê¸°íƒ€': -14481 },
        '2025_Year': { 'OC(êµ­ë‚´)': 764921, 'ì¤‘êµ­': 165656, 'í™ì½©': 28634, 'ê¸°íƒ€': -3397 },
      },
      'ì¸ê±´ë¹„': {
        '2024_4Q': { 'OC(êµ­ë‚´)': 43691, 'ì¤‘êµ­': 26129, 'í™ì½©': 7810, 'ê¸°íƒ€': 2154 },
        '2025_4Q': { 'OC(êµ­ë‚´)': 30081, 'ì¤‘êµ­': 21604, 'í™ì½©': 6283, 'ê¸°íƒ€': 1473 },
        '2024_Year': { 'OC(êµ­ë‚´)': 43691, 'ì¤‘êµ­': 26129, 'í™ì½©': 7810, 'ê¸°íƒ€': 2154 },
        '2025_Year': { 'OC(êµ­ë‚´)': 30081, 'ì¤‘êµ­': 21604, 'í™ì½©': 6283, 'ê¸°íƒ€': 1473 },
      },
      'ê´‘ê³ ì„ ì „ë¹„': {
        '2024_4Q': { 'OC(êµ­ë‚´)': 40354, 'ì¤‘êµ­': 45268, 'í™ì½©': 2013, 'ê¸°íƒ€': 6 },
        '2025_4Q': { 'OC(êµ­ë‚´)': 23314, 'ì¤‘êµ­': 40000, 'í™ì½©': 1672, 'ê¸°íƒ€': 0 },
        '2024_Year': { 'OC(êµ­ë‚´)': 40354, 'ì¤‘êµ­': 45268, 'í™ì½©': 2013, 'ê¸°íƒ€': 6 },
        '2025_Year': { 'OC(êµ­ë‚´)': 23314, 'ì¤‘êµ­': 40000, 'í™ì½©': 1672, 'ê¸°íƒ€': 0 },
      },
      'ìˆ˜ìˆ˜ë£Œ': {
        '2024_4Q': { 'OC(êµ­ë‚´)': 396901, 'ì¤‘êµ­': 41496, 'í™ì½©': 8633, 'ê¸°íƒ€': 815 },
        '2025_4Q': { 'OC(êµ­ë‚´)': 258952, 'ì¤‘êµ­': 34394, 'í™ì½©': 6402, 'ê¸°íƒ€': 294 },
        '2024_Year': { 'OC(êµ­ë‚´)': 396901, 'ì¤‘êµ­': 41496, 'í™ì½©': 8633, 'ê¸°íƒ€': 815 },
        '2025_Year': { 'OC(êµ­ë‚´)': 258952, 'ì¤‘êµ­': 34394, 'í™ì½©': 6402, 'ê¸°íƒ€': 294 },
      },
      'ê°ê°€ìƒê°ë¹„': {
        '2024_4Q': { 'OC(êµ­ë‚´)': 45461, 'ì¤‘êµ­': 24310, 'í™ì½©': 14356, 'ê¸°íƒ€': 748 },
        '2025_4Q': { 'OC(êµ­ë‚´)': 38818, 'ì¤‘êµ­': 19218, 'í™ì½©': 8008, 'ê¸°íƒ€': 531 },
        '2024_Year': { 'OC(êµ­ë‚´)': 45461, 'ì¤‘êµ­': 24310, 'í™ì½©': 14356, 'ê¸°íƒ€': 748 },
        '2025_Year': { 'OC(êµ­ë‚´)': 38818, 'ì¤‘êµ­': 19218, 'í™ì½©': 8008, 'ê¸°íƒ€': 531 },
      },
      'ê¸°íƒ€íŒê´€ë¹„': {
        '2024_4Q': { 'OC(êµ­ë‚´)': 45565, 'ì¤‘êµ­': 20369, 'í™ì½©': 6797, 'ê¸°íƒ€': 782 },
        '2025_4Q': { 'OC(êµ­ë‚´)': 28610, 'ì¤‘êµ­': 14614, 'í™ì½©': 7322, 'ê¸°íƒ€': 454 },
        '2024_Year': { 'OC(êµ­ë‚´)': 45565, 'ì¤‘êµ­': 20369, 'í™ì½©': 6797, 'ê¸°íƒ€': 782 },
        '2025_Year': { 'OC(êµ­ë‚´)': 28610, 'ì¤‘êµ­': 14614, 'í™ì½©': 7322, 'ê¸°íƒ€': 454 },
      },
      'ì˜ì—…ì´ìµ': {
        '2024_4Q': { 'OC(êµ­ë‚´)': 402407, 'ì¤‘êµ­': 36098, 'í™ì½©': 3356, 'ê¸°íƒ€': -18992 },
        '2025_4Q': { 'OC(êµ­ë‚´)': 385144, 'ì¤‘êµ­': 35823, 'í™ì½©': -1056, 'ê¸°íƒ€': -6154 },
        '2024_Year': { 'OC(êµ­ë‚´)': 402407, 'ì¤‘êµ­': 36098, 'í™ì½©': 3356, 'ê¸°íƒ€': -18992 },
        '2025_Year': { 'OC(êµ­ë‚´)': 385144, 'ì¤‘êµ­': 35823, 'í™ì½©': -1056, 'ê¸°íƒ€': -6154 },
      },
      'ë‹¹ê¸°ìˆœì´ìµ': {
        '2024_4Q': { 'OC(êµ­ë‚´)': 323532, 'ì¤‘êµ­': 25222, 'í™ì½©': 2128, 'ê¸°íƒ€': -18676 },
        '2025_4Q': { 'OC(êµ­ë‚´)': 294986, 'ì¤‘êµ­': 23921, 'í™ì½©': -1087, 'ê¸°íƒ€': -6843 },
        '2024_Year': { 'OC(êµ­ë‚´)': 323532, 'ì¤‘êµ­': 25222, 'í™ì½©': 2128, 'ê¸°íƒ€': -18676 },
        '2025_Year': { 'OC(êµ­ë‚´)': 294986, 'ì¤‘êµ­': 23921, 'í™ì½©': -1087, 'ê¸°íƒ€': -6843 },
      },
    };

    // í˜„ì¬ ëª¨ë“œì— ë”°ë¥¸ ê¸°ê°„ ì„¤ì • (ì„ íƒëœ ê¸°ê°„ ê¸°ì¤€)
    const getCurrentPeriodKey = () => {
      if (incomeViewMode === 'quarter') {
        return getPeriodKey(selectedPeriod, 'quarter');
      } else {
        // ëˆ„ì : ì„ íƒëœ ë¶„ê¸°ê¹Œì§€ì˜ ëˆ„ì 
        return getPeriodKey(selectedPeriod, 'year');
      }
    };

    const getPrevPeriodKey = () => {
      if (incomeViewMode === 'quarter') {
        // ë¶„ê¸°: ì „ë…„ ë™ ë¶„ê¸°
        return getPeriodKey(selectedPeriod, 'prev_quarter');
      } else {
        // ëˆ„ì : ì „ë…„ ë™ê¸° ëˆ„ì 
        return getPeriodKey(selectedPeriod, 'prev_year');
      }
    };

    const currPeriod = getCurrentPeriodKey();
    const prevPeriod = getPrevPeriodKey();
    const periodLabel = incomeViewMode === 'quarter' 
      ? selectedPeriod.replace('2025_', '').replace('Q', '') + 'ë¶„ê¸°'
      : 'ì—°ê°„';

    // ë²•ì¸ ìƒ‰ìƒ
    const entityColors = {
      'OC(êµ­ë‚´)': '#3B82F6',
      'ì¤‘êµ­': '#F59E0B',
      'í™ì½©': '#8B5CF6',
      'ê¸°íƒ€': '#6B7280',
      'ì—°ê²°ì¡°ì •': '#9CA3AF',
    };

    // ============================================
    // ë²•ì¸ë³„ ë¶„ì„ ë°ì´í„° ì •í•©ì„± ë³´ì •
    // - í˜„ì¬ entityDataëŠ” "ì—°ê²°ì¡°ì • ì „ í•©ì‚°" ê¸°ì¤€ì´ë©°, ì¼ë¶€ ê¸°ê°„(4Q/ì—°ê°„)ì´ ë™ì¼ ê°’ìœ¼ë¡œ ë“¤ì–´ê°€ ìˆìŒ
    // - UI í‘œ(ì—°ê²°) í•©ê³„ì™€ ë§ì¶”ê¸° ìœ„í•´, ì„ íƒ ê³¼ëª©/ê¸°ê°„ì˜ ì—°ê²° ê¸ˆì•¡ì„ ê¸°ì¤€ìœ¼ë¡œ
    //   1) ê¸°ì¤€ ë¶„í•´(ì—°ê°„ ë¶„í•´ê°’)ë¥¼ ìŠ¤ì¼€ì¼ë§í•˜ê³ 
    //   2) ë°˜ì˜¬ë¦¼ ì˜¤ì°¨/ì—°ê²°ì¡°ì • ì°¨ì´ëŠ” 'ì—°ê²°ì¡°ì •' ë¼ì¸ìœ¼ë¡œ ë³´ì •
    // ============================================
    const getConsolidatedTotal = (accountKey, period) => {
      const v = incomeStatementData?.[period]?.[accountKey];
      return typeof v === 'number' ? v : 0;
    };

    const getBaseEntityBreakdown = (accountKey, period) => {
      // ìš°ì„  í•´ë‹¹ period ê°’ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê°™ì€ ì—°ë„ì˜ Year ê°’ì„ ê¸°ì¤€(íŠ¹íˆ 4Q)ìœ¼ë¡œ ì‚¬ìš©
      const direct = entityData?.[accountKey]?.[period];
      if (direct && Object.keys(direct).length > 0) return direct;

      const fallbackPeriod = period.endsWith('_4Q') ? period.replace('_4Q', '_Year') : period;
      return entityData?.[accountKey]?.[fallbackPeriod] || {};
    };

    const getAlignedEntityBreakdown = (accountKey, period) => {
      const consolidatedTotal = getConsolidatedTotal(accountKey, period);
      const base = getBaseEntityBreakdown(accountKey, period);

      const baseKeys = Object.keys(base);
      if (baseKeys.length === 0) {
        return { 'ì—°ê²°ì¡°ì •': consolidatedTotal };
      }

      const baseSum = baseKeys.reduce((sum, k) => sum + (base[k] || 0), 0);
      if (baseSum === 0) {
        return { ...base, 'ì—°ê²°ì¡°ì •': consolidatedTotal };
      }

      const scale = consolidatedTotal / baseSum;
      const scaled = {};
      for (const k of baseKeys) {
        // ë°˜ì˜¬ë¦¼ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ì°¨ì´ëŠ” ì—°ê²°ì¡°ì •ìœ¼ë¡œ í¡ìˆ˜
        scaled[k] = Math.round((base[k] || 0) * scale);
      }

      const scaledSum = Object.values(scaled).reduce((sum, v) => sum + (v || 0), 0);
      const adjustment = consolidatedTotal - scaledSum;
      return { ...scaled, 'ì—°ê²°ì¡°ì •': adjustment };
    };

    // í‘œì‹œìš© ê·¸ë£¹í•‘: ë¹„ì¤‘ì´ ì‘ì€ ë²•ì¸ + ì—°ê²°ì¡°ì •ì„ 'ê¸°íƒ€(ì—°ê²°ì¡°ì •)'ë¡œ í•©ì‚°
    const MINOR_ENTITY_RATIO_THRESHOLD = 0.03; // 3% ë¯¸ë§Œì€ ê¸°íƒ€ë¡œ í•©ì‚°
    const MERGED_ENTITY_LABEL = 'ê¸°íƒ€(ì—°ê²°ì¡°ì •)';
    const MAJOR_ENTITIES = ['OC(êµ­ë‚´)', 'ì¤‘êµ­'];

    // ë‹¨ì¼ ê¸°ê°„ìš© (ë„ë„› ì°¨íŠ¸ ë“±)
    const getGroupedEntityBreakdown = (accountKey, period) => {
      return getGroupedEntityBreakdownForComparison(accountKey, period, period);
    };

    // ë¹„êµìš©: ì „ê¸°/ë‹¹ê¸° ë‘˜ ë‹¤ë¥¼ ê³ ë ¤í•˜ì—¬, í•œ ê¸°ê°„ì´ë¼ë„ ìœ ì˜ë¯¸í•˜ë©´ ê°œë³„ë¡œ ìœ ì§€
    const getGroupedEntityBreakdownForComparison = (accountKey, prevPeriod, currPeriod) => {
      const totalCurr = getConsolidatedTotal(accountKey, currPeriod);
      const totalPrev = getConsolidatedTotal(accountKey, prevPeriod);
      const alignedCurr = getAlignedEntityBreakdown(accountKey, currPeriod);
      const alignedPrev = getAlignedEntityBreakdown(accountKey, prevPeriod);

      // ì „ê¸°/ë‹¹ê¸° ëª¨ë‘ì˜ í‚¤ë¥¼ í•©ì§‘í•©ìœ¼ë¡œ ìˆ˜ì§‘
      const allKeys = Array.from(new Set([...Object.keys(alignedPrev), ...Object.keys(alignedCurr)]));

      const merged = {};
      const entitiesToKeep = new Set();

      // 1. OC(êµ­ë‚´), ì¤‘êµ­ì€ í•­ìƒ ìœ ì§€
      MAJOR_ENTITIES.forEach(entity => {
        if (allKeys.includes(entity)) {
          entitiesToKeep.add(entity);
        }
      });

      // 2. ì „ê¸°ë‚˜ ë‹¹ê¸° ì¤‘ í•˜ë‚˜ë¼ë„ ë°ì´í„°ê°€ ìˆê³ , ê·¸ ê¸°ê°„ì˜ ë¹„ì¤‘ì´ 3% ì´ìƒì´ë©´ ê°œë³„ë¡œ ìœ ì§€
      for (const name of allKeys) {
        if (MAJOR_ENTITIES.includes(name) || name === 'ì—°ê²°ì¡°ì •' || name === 'ê¸°íƒ€') continue;

        const prevVal = alignedPrev[name] || 0;
        const currVal = alignedCurr[name] || 0;
        
        const prevRatio = totalPrev !== 0 ? Math.abs(prevVal) / Math.abs(totalPrev) : 0;
        const currRatio = totalCurr !== 0 ? Math.abs(currVal) / Math.abs(totalCurr) : 0;

        // ì „ê¸°ë‚˜ ë‹¹ê¸° ì¤‘ í•˜ë‚˜ë¼ë„ ë°ì´í„°ê°€ ìˆê³ , ê·¸ ê¸°ê°„ì˜ ë¹„ì¤‘ì´ 3% ì´ìƒì´ë©´ ê°œë³„ ìœ ì§€
        const hasDataInEitherPeriod = prevVal !== 0 || currVal !== 0;
        const isSignificantInEitherPeriod = prevRatio >= MINOR_ENTITY_RATIO_THRESHOLD || currRatio >= MINOR_ENTITY_RATIO_THRESHOLD;

        if (hasDataInEitherPeriod && isSignificantInEitherPeriod) {
          entitiesToKeep.add(name);
        }
      }

      // 3. ìœ ì§€í•  ë²•ì¸ë“¤ì„ mergedì— ì¶”ê°€ (ë‹¹ê¸° ê°’ì„ ì‚¬ìš©)
      entitiesToKeep.forEach(name => {
        merged[name] = alignedCurr[name] || 0;
      });

      // 4. ë‚˜ë¨¸ì§€ëŠ” ê¸°íƒ€(ì—°ê²°ì¡°ì •)ë¡œ í¡ìˆ˜ (í•©ê³„ ì •í•©ì„± ë³´ì¥)
      const keptSum = Object.values(merged).reduce((s, v) => s + (v || 0), 0);
      merged[MERGED_ENTITY_LABEL] = totalCurr - keptSum;

      return merged;
    };

    // ë„ë„› ì°¨íŠ¸ìš© ë°ì´í„° ë³€í™˜ (ì–‘ìˆ˜ ê°’ë§Œ í‘œì‹œ)
    const getDonutData = (period) => {
      const data = getGroupedEntityBreakdown(selectedAccount, period);
      return Object.entries(data)
        .filter(([_, value]) => value > 0) // ì–‘ìˆ˜ë§Œ í•„í„°ë§ (ë„ë„›ì€ ìŒìˆ˜ í‘œí˜„ì´ ì–´ë ¤ì›€)
        .map(([name, value]) => ({
          name,
          value: value || 0,
          color:
            name === MERGED_ENTITY_LABEL
              ? '#6B7280'
              : (entityColors[name] || '#9CA3AF'),
        }));
    };

    // ë²•ì¸ë³„ í…Œì´ë¸” ë°ì´í„° - í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ì—°ë™
    const getEntityTableData = () => {
      // ë¹„êµìš© í•¨ìˆ˜ ì‚¬ìš©: ì „ê¸°/ë‹¹ê¸° ë‘˜ ë‹¤ë¥¼ ê³ ë ¤
      const curr = getGroupedEntityBreakdownForComparison(selectedAccount, prevPeriod, currPeriod);
      const prev = getGroupedEntityBreakdownForComparison(selectedAccount, prevPeriod, prevPeriod);
      const totalCurr = getConsolidatedTotal(selectedAccount, currPeriod);
      
      // í‘œ í‘œì‹œ ìˆœì„œ:
      // - OC/ì¤‘êµ­ì€ í•­ìƒ ìƒë‹¨
      // - ê·¸ ì™¸(ì˜ˆ: í™ì½©)ê°€ ì„ê³„ì¹˜ ì´ìƒì´ë©´ ê°œë³„ë¡œ ë‚¨ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë™ì ìœ¼ë¡œ í¬í•¨
      // - ê¸°íƒ€(ì—°ê²°ì¡°ì •)ëŠ” í•­ìƒ ë§ˆì§€ë§‰
      const keyUnion = Array.from(
        new Set([...Object.keys(prev), ...Object.keys(curr)])
      );

      const dynamicEntities = keyUnion
        .filter((k) => k !== MERGED_ENTITY_LABEL && !MAJOR_ENTITIES.includes(k))
        .sort(
          (a, b) =>
            Math.max(Math.abs(curr[b] || 0), Math.abs(prev[b] || 0)) -
            Math.max(Math.abs(curr[a] || 0), Math.abs(prev[a] || 0))
        );

      const entityOrder = [...MAJOR_ENTITIES, ...dynamicEntities, MERGED_ENTITY_LABEL].filter(
        (v, i, arr) => arr.indexOf(v) === i
      );

      return entityOrder.map(entity => {
        const prevVal = prev[entity] || 0;
        const currVal = curr[entity] || 0;
        const ratio = totalCurr > 0 ? ((currVal / totalCurr) * 100).toFixed(1) : '0.0';
        const change = prevVal !== 0 ? (((currVal - prevVal) / Math.abs(prevVal)) * 100).toFixed(1) : '-';
        return { entity, prevVal, currVal, ratio, change };
      });
    };

    // ì†ìµê³„ì‚°ì„œ í•­ëª© ì •ì˜
    const incomeItems = [
      { key: 'ë§¤ì¶œì•¡', label: 'I. ë§¤ì¶œì•¡', depth: 0, bold: true, selectable: true },
      { key: 'ë§¤ì¶œì›ê°€', label: 'II. ë§¤ì¶œì›ê°€', depth: 0, bold: true, selectable: true },
      { key: 'ë§¤ì¶œì´ì´ìµ', label: 'III. ë§¤ì¶œì´ì´ìµ', depth: 0, bold: true, selectable: true },
      { key: 'ë§¤ì¶œì´ì´ìµë¥ ', label: 'ë§¤ì¶œì´ì´ìµë¥ ', depth: 0, isRate: true, rateOf: ['ë§¤ì¶œì´ì´ìµ', 'ë§¤ì¶œì•¡'], highlight: 'blue' },
      { key: 'íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„', label: 'IV. íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„', depth: 0, bold: true },
      { key: 'ì¸ê±´ë¹„', label: '(1)ì¸ê±´ë¹„', depth: 1, selectable: true },
      { key: 'ê´‘ê³ ì„ ì „ë¹„', label: '(2)ê´‘ê³ ì„ ì „ë¹„', depth: 1, selectable: true },
      { key: 'ìˆ˜ìˆ˜ë£Œ', label: '(3)ìˆ˜ìˆ˜ë£Œ', depth: 1, selectable: true },
      { key: 'ê°ê°€ìƒê°ë¹„', label: '(4)ê°ê°€ìƒê°ë¹„', depth: 1, selectable: true },
      { key: 'ê¸°íƒ€íŒê´€ë¹„', label: '(5)ê¸°íƒ€', depth: 1, selectable: true },
      { key: 'ì˜ì—…ì´ìµ', label: 'V. ì˜ì—…ì´ìµ', depth: 0, bold: true, highlight: 'green', selectable: true },
      { key: 'ì˜ì—…ì´ìµë¥ ', label: 'ì˜ì—…ì´ìµë¥ ', depth: 0, isRate: true, rateOf: ['ì˜ì—…ì´ìµ', 'ë§¤ì¶œì•¡'], highlight: 'blue' },
      { key: 'ì˜ì—…ì™¸ì†ìµ', label: 'VI. ì˜ì—…ì™¸ì†ìµ', depth: 0, bold: true, toggleParent: true },
      { key: 'ì™¸í™˜ì†ìµ', label: '(1)ì™¸í™˜ì†ìµ', depth: 1, toggleChild: true },
      { key: 'ì„ ë¬¼í™˜ì†ìµ', label: '(2)ì„ ë¬¼í™˜ì†ìµ', depth: 1, toggleChild: true },
      { key: 'ê¸ˆìœµìƒí’ˆì†ìµ', label: '(3)ê¸ˆìœµìƒí’ˆì†ìµ', depth: 1, toggleChild: true },
      { key: 'ì´ìì†ìµ', label: '(4)ì´ìì†ìµ', depth: 1, toggleChild: true },
      { key: 'ë°°ë‹¹ìˆ˜ìµ', label: '(5)ë°°ë‹¹ìˆ˜ìµ', depth: 1, toggleChild: true },
      { key: 'ê¸°ë¶€ê¸ˆ', label: '(6)ê¸°ë¶€ê¸ˆ', depth: 1, toggleChild: true },
      { key: 'ê¸°íƒ€ì†ìµ', label: '(7)ê¸°íƒ€ì†ìµ', depth: 1, toggleChild: true },
      { key: 'ì§€ë¶„ë²•ì†ìµ', label: 'VII. ì§€ë¶„ë²•ì†ìµ', depth: 0, bold: true },
      { key: 'ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ', label: 'VIII. ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ', depth: 0, bold: true },
      { key: 'ë²•ì¸ì„¸ë¹„ìš©', label: 'IX. ë²•ì¸ì„¸ë¹„ìš©', depth: 0, bold: true },
      { key: 'ë²•ì¸ì„¸ìœ¨', label: 'ë²•ì¸ì„¸ìœ¨', depth: 0, isRate: true, rateOf: ['ë²•ì¸ì„¸ë¹„ìš©', 'ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ'], highlight: 'blue' },
      { key: 'ë‹¹ê¸°ìˆœì´ìµ', label: 'X. ë‹¹ê¸°ìˆœì´ìµ', depth: 0, bold: true, highlight: 'green', selectable: true },
      { key: 'ë‹¹ê¸°ìˆœì´ìµë¥ ', label: 'ë‹¹ê¸°ìˆœì´ìµë¥ ', depth: 0, isRate: true, rateOf: ['ë‹¹ê¸°ìˆœì´ìµ', 'ë§¤ì¶œì•¡'], highlight: 'blue' },
    ];

    // ì„ íƒ ê°€ëŠ¥í•œ ê³¼ëª© ëª©ë¡
    const selectableAccounts = incomeItems.filter(item => item.selectable).map(item => item.key);

    // ìš”ì•½ ì¹´ë“œ ë°ì´í„°
    const summaryCards = [
      {
        title: 'ë§¤ì¶œì•¡',
        key: 'ë§¤ì¶œì•¡',
        hasRate: false,
      },
      {
        title: 'ë§¤ì¶œì´ì´ìµ',
        key: 'ë§¤ì¶œì´ì´ìµ',
        hasRate: true,
        rateLabel: 'ë§¤ì¶œì´ì´ìµë¥ ',
        rateOf: ['ë§¤ì¶œì´ì´ìµ', 'ë§¤ì¶œì•¡'],
      },
      {
        title: 'ì˜ì—…ì´ìµ',
        key: 'ì˜ì—…ì´ìµ',
        hasRate: true,
        rateLabel: 'ì˜ì—…ì´ìµë¥ ',
        rateOf: ['ì˜ì—…ì´ìµ', 'ë§¤ì¶œì•¡'],
      },
      {
        title: 'ë‹¹ê¸°ìˆœì´ìµ',
        key: 'ë‹¹ê¸°ìˆœì´ìµ',
        hasRate: true,
        rateLabel: 'ë‹¹ê¸°ìˆœì´ìµë¥ ',
        rateOf: ['ë‹¹ê¸°ìˆœì´ìµ', 'ë§¤ì¶œì•¡'],
      },
    ];

    // ìš”ì•½ ì¹´ë“œëŠ” ì¡°íšŒ ì‹œì  ê¸°ì¤€ ëˆ„ì (ì—°ê°„) ë°ì´í„° ì‚¬ìš©
    const incomeSummaryYearKey = getPeriodKey(selectedPeriod, 'year');
    const incomeSummaryPrevYearKey = getPeriodKey(selectedPeriod, 'prev_year') || '2024_Year';

    return (
      <div className="space-y-4">
        {/* ìš”ì•½ ì¹´ë“œ ì„¹ì…˜ - ì¡°íšŒ ì‹œì  ê¸°ì¤€ ëˆ„ì  ì‹¤ì  */}
        <div>
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-semibold text-zinc-700">ì‹¤ì  ìš”ì•½ (ëˆ„ì )</h3>
          </div>

          <div className="grid grid-cols-4 gap-3">
          {summaryCards.map((card, idx) => {
            // ì„ íƒëœ ê¸°ê°„ ê¸°ì¤€ ëˆ„ì (ì—°ê°„) ë°ì´í„°
            const curr = incomeStatementData[incomeSummaryYearKey]?.[card.key] || 0;
            const prev = incomeStatementData[incomeSummaryPrevYearKey]?.[card.key] || 0;
            const diff = curr - prev;
            const changeRate = calculateYoY(curr, prev);
            const isPositive = parseFloat(changeRate) >= 0;
            
            // ì–µì› ë‹¨ìœ„ ë³€í™˜ (ë°±ë§Œì› -> ì–µì›)
            const currBil = Math.round(curr / 100);
            const prevBil = Math.round(prev / 100);
            const diffBil = Math.round(diff / 100);
            
            // ì¡°ë‹¨ìœ„ í¬ë§· í•¨ìˆ˜
            const formatTrilBil = (val) => {
              if (val === 0) return '0';
              const absVal = Math.abs(val);
              const sign = val < 0 ? '-' : '';
              if (absVal >= 10000) {
                const tril = Math.floor(absVal / 10000);
                const bil = Math.round(absVal % 10000);
                return `${sign}${tril}ì¡° ${formatNumber(bil)}`;
              }
              return `${sign}${formatNumber(absVal)}`;
            };
            
            // ë¹„ìœ¨ ê³„ì‚°
            let currRate = null;
            let prevRate = null;
            let rateDiff = null;
            if (card.hasRate) {
              const [num, denom] = card.rateOf;
              const currNum = incomeStatementData[incomeSummaryYearKey]?.[num] || 0;
              const currDenom = incomeStatementData[incomeSummaryYearKey]?.[denom] || 0;
              const prevNum = incomeStatementData[incomeSummaryPrevYearKey]?.[num] || 0;
              const prevDenom = incomeStatementData[incomeSummaryPrevYearKey]?.[denom] || 0;
              
              currRate = currDenom > 0 ? ((currNum / currDenom) * 100).toFixed(1) : '0.0';
              prevRate = prevDenom > 0 ? ((prevNum / prevDenom) * 100).toFixed(1) : '0.0';
              rateDiff = (parseFloat(currRate) - parseFloat(prevRate)).toFixed(1);
            }
            
            return (
              <div 
                key={idx}
                className="bg-white rounded-lg border border-zinc-200 shadow-sm p-4 hover:shadow-md transition-all duration-200"
              >
                <div className="flex items-center justify-between mb-3">
                  <span className="text-xs font-medium text-zinc-500 uppercase tracking-wide">{card.title}</span>
                  <span className={`text-xs font-semibold px-2 py-0.5 rounded ${
                    isPositive ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'
                  }`}>
                    {changeRate !== '-' ? `${isPositive ? '+' : ''}${changeRate}%` : '-'}
                  </span>
                </div>
                
                {/* ê¸ˆì•¡ (ì–µì› ë‹¨ìœ„ + ì¡°ë‹¨ìœ„ í‘œê¸°) */}
                <div className="flex items-baseline gap-1">
                  <span className="text-2xl font-bold text-zinc-900 tracking-tight">{formatTrilBil(currBil)}</span>
                  <span className="text-sm font-normal text-zinc-400">ì–µì›</span>
                </div>
                
                {/* ì „ë…„ë™ê¸° & ì¦ê° */}
                <div className="flex items-center gap-2 mt-1 text-xs">
                  <span className="text-zinc-400">ì „ë…„ {formatTrilBil(prevBil)}ì–µ</span>
                  <span className={`font-semibold ${isPositive ? 'text-emerald-600' : 'text-rose-600'}`}>
                    {diffBil >= 0 ? '+' : ''}{formatTrilBil(diffBil)}ì–µ
                  </span>
                </div>
                
                {/* ë¹„ìœ¨ (í•´ë‹¹ë˜ëŠ” ê²½ìš°) */}
                {card.hasRate && (
                  <div className="mt-3 pt-3 border-t border-zinc-100">
                    <div className="flex items-center justify-between">
                      <span className="text-xs text-zinc-400">{card.rateLabel}</span>
                      <div className="flex items-center gap-1.5">
                        <span className="text-sm font-bold text-zinc-900">{currRate}%</span>
                        <span className={`text-xs font-semibold ${parseFloat(rateDiff) >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                          {parseFloat(rateDiff) >= 0 ? '+' : ''}{rateDiff}%p
                        </span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
          </div>
        </div>

        {/* ì†ìµê³„ì‚°ì„œ í…Œì´ë¸” & ë²•ì¸ë³„ ë¶„ì„ */}
        <div className="flex flex-col xl:flex-row gap-4">
        {/* ì¢Œì¸¡: ì†ìµê³„ì‚°ì„œ í…Œì´ë¸” */}
        <div className="flex-1 min-w-0">
          <div className="bg-white rounded-lg border border-zinc-200 shadow-sm overflow-hidden">
            <div className="px-4 py-3 border-b border-zinc-200 bg-zinc-50">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <h3 className="text-sm font-semibold text-zinc-900">ì—°ê²° ì†ìµê³„ì‚°ì„œ</h3>
                </div>
                {/* ë¶„ê¸°/ëˆ„ì  ì„ íƒ ë²„íŠ¼ */}
                <div className="inline-flex p-0.5 bg-zinc-100 rounded-lg border border-zinc-200">
                  <button
                    onClick={() => setIncomeViewMode('quarter')}
                    className={`px-3 py-1 text-xs font-medium rounded transition-all duration-150 ${
                      incomeViewMode === 'quarter'
                        ? 'bg-white text-zinc-900 border border-zinc-200 shadow-sm'
                        : 'text-zinc-500 hover:text-zinc-700'
                    }`}
                  >
                    ë¶„ê¸°
                  </button>
                  <button
                    onClick={() => setIncomeViewMode('annual')}
                    className={`px-3 py-1 text-xs font-medium rounded transition-all duration-150 ${
                      incomeViewMode === 'annual'
                        ? 'bg-white text-zinc-900 border border-zinc-200 shadow-sm'
                        : 'text-zinc-500 hover:text-zinc-700'
                    }`}
                  >
                    ëˆ„ì  (ì—°ê°„)
                  </button>
                </div>
              </div>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="bg-zinc-50 border-b border-zinc-200">
                    <th className="text-left px-3 py-2.5 font-semibold text-zinc-700 border-r border-zinc-200 min-w-[175px]">ê³¼ëª©</th>
                    <th className="text-center px-3 py-2 font-semibold text-zinc-600 border-r border-zinc-200 min-w-[95px]">
                      {(() => {
                        const [yearStr, qStr] = selectedPeriod.split('_'); // ì˜ˆ: ['2025','Q2']
                        const quarterNum = (qStr || 'Q4').replace('Q', '');
                        const prevYear = String(Number(yearStr) - 1);
                        return incomeViewMode === 'quarter'
                          ? `${prevYear}.${quarterNum}Q`
                          : `${prevYear}ë…„`;
                      })()}
                    </th>
                    <th className="text-center px-3 py-2 font-semibold text-zinc-900 border-r border-zinc-200 bg-zinc-100 min-w-[95px]">
                      {(() => {
                        const [yearStr, qStr] = selectedPeriod.split('_'); // ì˜ˆ: ['2025','Q2']
                        const quarterNum = (qStr || 'Q4').replace('Q', '');
                        return incomeViewMode === 'quarter'
                          ? `${yearStr}.${quarterNum}Q`
                          : `${yearStr}ë…„`;
                      })()}
                    </th>
                    <th className="text-center px-3 py-2 font-semibold text-zinc-600 border-r border-zinc-200 min-w-[90px]">ì¦ê°ì•¡</th>
                    <th className="text-center px-3 py-2 font-semibold text-zinc-600 min-w-[70px]">ì¦ê°ë¥ </th>
                  </tr>
                </thead>
                <tbody>
                  {incomeItems.map((item, idx) => {
                    const isRateRow = item.isRate;
                    const isSelectable = item.selectable;
                    const isSelected = selectedAccount === item.key;
                    const isToggleParent = item.toggleParent;
                    const isToggleChild = item.toggleChild;
                    
                    // í† ê¸€ ìì‹ í•­ëª©ì´ê³  ì ‘í˜€ìˆìœ¼ë©´ ë Œë”ë§í•˜ì§€ ì•ŠìŒ
                    if (isToggleChild && !isNonOperatingExpanded) {
                      return null;
                    }
                    
                    // ë¹„ìœ¨ í–‰ ì²˜ë¦¬
                    if (isRateRow) {
                      const [num, denom] = item.rateOf;
                      const ratePrev = calcRate(incomeStatementData[prevPeriod][num], incomeStatementData[prevPeriod][denom]);
                      const rateCurr = calcRate(incomeStatementData[currPeriod][num], incomeStatementData[currPeriod][denom]);
                      const rateDiff = calcRateDiff(rateCurr, ratePrev);
                      
                      return (
                        <tr key={idx} className="border-b border-zinc-100 bg-zinc-50/50">
                          <td className="px-3 py-2 text-zinc-500 italic border-r border-zinc-200 text-xs">{item.label}</td>
                          <td className="text-center px-3 py-2 text-zinc-500 border-r border-zinc-200">{ratePrev}</td>
                          <td className="text-center px-3 py-2 font-medium text-zinc-700 border-r border-zinc-200 bg-zinc-50">{rateCurr}</td>
                          <td colSpan="2" className={`text-center px-3 py-2 font-medium ${rateDiff.includes('+') ? 'text-emerald-600' : rateDiff.includes('-') ? 'text-rose-600' : 'text-zinc-500'}`}>
                            {rateDiff}
                          </td>
                        </tr>
                      );
                    }

                    // ì¼ë°˜ ê¸ˆì•¡ í–‰ ì²˜ë¦¬
                    const valPrev = incomeStatementData[prevPeriod][item.key];
                    const valCurr = incomeStatementData[currPeriod][item.key];
                    const diff = valCurr - valPrev;
                    const changeRate = calculateYoY(valCurr, valPrev);
                    
                    const highlightClass = item.highlight === 'green' ? 'bg-emerald-50/50' : '';
                    const selectableClass = isSelectable ? 'cursor-pointer hover:bg-zinc-100' : '';
                    const selectedClass = isSelected ? 'bg-zinc-100 ring-1 ring-zinc-300 ring-inset' : '';
                    const toggleParentClass = isToggleParent ? 'cursor-pointer hover:bg-zinc-50' : '';
                    
                    return (
                      <tr 
                        key={idx} 
                        className={`border-b border-zinc-100 ${highlightClass} ${selectableClass} ${selectedClass} ${toggleParentClass}`}
                        onClick={() => {
                          if (isSelectable) setSelectedAccount(item.key);
                          if (isToggleParent) setIsNonOperatingExpanded(!isNonOperatingExpanded);
                        }}
                      >
                        <td className={`px-3 py-2 border-r border-zinc-200 ${item.bold ? 'font-semibold text-zinc-900' : 'text-zinc-600'} ${item.depth === 1 ? 'pl-6' : ''}`}>
                          {isToggleParent && (
                            <span className="inline-flex items-center justify-center w-4 h-4 mr-1.5 rounded bg-zinc-200 text-zinc-600 text-xs font-medium">
                              {isNonOperatingExpanded ? 'âˆ’' : '+'}
                            </span>
                          )}
                          {item.label}
                        </td>
                        <td className="text-right px-3 py-2 text-zinc-500 border-r border-zinc-200 tabular-nums">{formatNumber(valPrev)}</td>
                        <td className={`text-right px-3 py-2 border-r border-zinc-200 tabular-nums bg-zinc-50/50 ${item.bold ? 'font-semibold text-zinc-900' : 'text-zinc-700'}`}>{formatNumber(valCurr)}</td>
                        <td className={`text-right px-3 py-2 font-medium border-r border-zinc-200 tabular-nums ${diff >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                          {diff !== 0 ? formatNumber(diff) : '-'}
                        </td>
                        <td className={`text-right px-3 py-2 font-medium tabular-nums ${parseFloat(changeRate) >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                          {changeRate !== '-' ? `${changeRate}%` : '-'}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        {/* ìš°ì¸¡: ë²•ì¸ë³„ ë¶„ì„ */}
        <div className="w-full xl:w-[360px] flex-shrink-0 space-y-3">
          {/* ë²•ì¸ë³„ ë¶„ì„ í—¤ë” */}
          <div className="bg-white rounded-lg border border-zinc-200 shadow-sm p-4">
            <h3 className="text-sm font-semibold text-zinc-900 mb-0.5">
              {incomeItems.find(i => i.key === selectedAccount)?.label || selectedAccount} ë²•ì¸ë³„ ë¶„ì„
            </h3>
            <p className="text-xs text-zinc-400">{periodLabel} ê¸°ì¤€ ë²•ì¸ë³„ ë¹„ì¤‘</p>
            
            {/* ë„ë„› ì°¨íŠ¸ ì˜ì—­ */}
            <div className="flex justify-around mt-4">
              <div className="text-center">
                <p className="text-xs font-medium text-zinc-500 mb-2">
                  {incomeViewMode === 'quarter' ? '2024.4Q' : '2024ë…„'}
                </p>
                <div style={{ width: 110, height: 110 }}>
                  {getDonutData(prevPeriod).length > 0 ? (
                    <PieChart width={110} height={110}>
                      <Pie
                        data={getDonutData(prevPeriod)}
                        cx={55}
                        cy={55}
                        innerRadius={28}
                        outerRadius={48}
                        paddingAngle={2}
                        dataKey="value"
                      >
                        {getDonutData(prevPeriod).map((entry, index) => (
                          <Cell key={`cell-prev-${index}`} fill={entry.color} />
                        ))}
                      </Pie>
                      <Tooltip 
                        content={<CustomPieTooltip formatter={(value) => `${formatNumber(Math.round(value/100))}ì–µì›`} />}
                      />
                    </PieChart>
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-zinc-400 text-xs">ë°ì´í„° ì—†ìŒ</div>
                  )}
                </div>
              </div>
              <div className="text-center">
                <p className="text-xs font-medium text-zinc-500 mb-2">
                  {incomeViewMode === 'quarter' ? '2025.4Q' : '2025ë…„'}
                </p>
                <div style={{ width: 110, height: 110 }}>
                  {getDonutData(currPeriod).length > 0 ? (
                    <PieChart width={110} height={110}>
                      <Pie
                        data={getDonutData(currPeriod)}
                        cx={55}
                        cy={55}
                        innerRadius={28}
                        outerRadius={48}
                        paddingAngle={2}
                        dataKey="value"
                      >
                        {getDonutData(currPeriod).map((entry, index) => (
                          <Cell key={`cell-curr-${index}`} fill={entry.color} />
                        ))}
                      </Pie>
                      <Tooltip 
                        content={<CustomPieTooltip formatter={(value) => `${formatNumber(Math.round(value/100))}ì–µì›`} />}
                      />
                    </PieChart>
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-zinc-400 text-xs">ë°ì´í„° ì—†ìŒ</div>
                  )}
                </div>
              </div>
            </div>
            
            {/* ë²”ë¡€ */}
            <div className="flex flex-wrap justify-center gap-3 mt-3">
              {Object.entries(entityColors).map(([name, color]) => (
                <div key={name} className="flex items-center gap-1.5">
                  <span className="w-2 h-2 rounded-full" style={{ backgroundColor: color }}></span>
                  <span className="text-xs text-zinc-500">{name}</span>
                </div>
              ))}
            </div>
          </div>

          {/* ë²•ì¸ë³„ í…Œì´ë¸” */}
          <div className="bg-white rounded-lg border border-zinc-200 shadow-sm overflow-hidden">
            <table className="w-full text-sm">
              <thead>
                <tr className="bg-zinc-50 border-b border-zinc-200">
                  <th className="text-left px-3 py-2 font-semibold text-zinc-600 min-w-[80px] whitespace-nowrap">ë²•ì¸</th>
                  <th className="text-right px-2 py-2 font-semibold text-zinc-600 min-w-[85px]">
                    {incomeViewMode === 'quarter' ? '24.4Q' : '2024'}
                  </th>
                  <th className="text-right px-2 py-2 font-semibold text-zinc-600 min-w-[85px]">
                    {incomeViewMode === 'quarter' ? '25.4Q' : '2025'}
                  </th>
                  <th className="text-right px-2 py-2 font-semibold text-zinc-600 min-w-[55px]">ë¹„ì¤‘</th>
                  <th className="text-right px-3 py-2 font-semibold text-zinc-600 min-w-[70px] whitespace-nowrap">YoY</th>
                </tr>
              </thead>
              <tbody>
                {getEntityTableData().map((row, idx) => (
                  <tr key={idx} className="border-b border-zinc-100 hover:bg-zinc-50 transition-colors">
                    <td className="px-3 py-2 text-zinc-700 whitespace-nowrap">
                      <span 
                        className="inline-block w-2 h-2 rounded-full mr-1.5" 
                        style={{ backgroundColor: entityColors[row.entity] }}
                      ></span>
                      {row.entity}
                    </td>
                    <td className="text-right px-2 py-2 text-zinc-500 tabular-nums">{formatNumber(row.prevVal)}</td>
                    <td className="text-right px-2 py-2 text-zinc-900 font-medium tabular-nums">{formatNumber(row.currVal)}</td>
                    <td className="text-right px-2 py-2 text-zinc-500 tabular-nums">{row.ratio}%</td>
                    <td className={`text-right px-3 py-2 font-medium tabular-nums whitespace-nowrap ${parseFloat(row.change) >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                      {row.change !== '-' ? `${parseFloat(row.change) >= 0 ? '+' : ''}${row.change}%` : '-'}
                    </td>
                  </tr>
                ))}
                {/* í•©ê³„ í–‰ */}
                <tr className="bg-zinc-50 font-medium">
                  <td className="px-3 py-2 text-zinc-900 whitespace-nowrap">í•©ê³„</td>
                  <td className="text-right px-2 py-2 text-zinc-700 tabular-nums">
                    {formatNumber(getEntityTableData().reduce((sum, r) => sum + r.prevVal, 0))}
                  </td>
                  <td className="text-right px-2 py-2 text-zinc-900 tabular-nums">
                    {formatNumber(getEntityTableData().reduce((sum, r) => sum + r.currVal, 0))}
                  </td>
                  <td className="text-right px-2 py-2 text-zinc-700 tabular-nums">100%</td>
                  <td className="text-right px-3 py-2 text-zinc-400 whitespace-nowrap">-</td>
                </tr>
              </tbody>
            </table>
            <p className="text-[10px] text-zinc-400 px-3 py-1.5 bg-zinc-50 border-t border-zinc-100">* ë‹¨ìœ„: ë°±ë§Œì› (ì—°ê²°ì¡°ì • ì „ ë²•ì¸ë³„ í•©ì‚°)</p>
          </div>

          {/* ë²•ì¸ë³„ ì¦ê° ë¶„ì„ - ë™ì  ìƒì„± */}
          <div className="bg-white rounded-lg border border-zinc-200 shadow-sm p-3">
            <h4 className="text-xs font-semibold text-zinc-700 mb-2">ğŸ“Š YoY ì¦ê° ë¶„ì„</h4>
            <div className="space-y-2 text-xs">
              {(() => {
                const tableData = getEntityTableData().filter(row => row.entity !== 'ê¸°íƒ€');
                const totalCurr = tableData.reduce((sum, r) => sum + r.currVal, 0);
                const totalPrev = tableData.reduce((sum, r) => sum + r.prevVal, 0);
                const totalDiff = totalCurr - totalPrev;
                
                return tableData
                  .sort((a, b) => Math.abs(b.currVal - b.prevVal) - Math.abs(a.currVal - a.prevVal))
                  .map((row, idx) => {
                    const diff = row.currVal - row.prevVal;
                    const isPositive = diff >= 0;
                    const contribution = totalDiff !== 0 ? ((diff / Math.abs(totalDiff)) * 100).toFixed(0) : 0;
                    const diffBil = Math.round(diff / 100); // ì–µì› ë‹¨ìœ„
                    
                    const colorMap = {
                      'OC(êµ­ë‚´)': { bg: 'bg-blue-50/50', border: 'border-blue-400', icon: 'ğŸ¢' },
                      'ì¤‘êµ­': { bg: 'bg-amber-50/50', border: 'border-amber-400', icon: 'ğŸ‡¨ğŸ‡³' },
                      'í™ì½©': { bg: 'bg-violet-50/50', border: 'border-violet-400', icon: 'ğŸ‡­ğŸ‡°' },
                    };
                    const colors = colorMap[row.entity] || { bg: 'bg-zinc-50', border: 'border-zinc-300', icon: 'ğŸ“' };
                    
                    return (
                      <div key={idx} className={`p-2.5 ${colors.bg} rounded-lg border-l-2 ${colors.border}`}>
                        <div className="flex items-center justify-between">
                          <span className="font-medium text-zinc-800">{colors.icon} {row.entity}</span>
                          <span className={`text-xs font-bold px-1.5 py-0.5 rounded ${isPositive ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>
                            {isPositive ? 'â–²' : 'â–¼'} {row.change}%
                          </span>
                        </div>
                        <div className="mt-1.5 flex items-center justify-between text-[11px]">
                          <span className="text-zinc-500">
                            {isPositive ? '+' : ''}{formatNumber(diffBil)}ì–µì›
                          </span>
                          <span className="text-zinc-400">
                            ê¸°ì—¬ë„ {contribution}%
                          </span>
                        </div>
                      </div>
                    );
                  });
              })()}
            </div>
            
            {/* ì „ì²´ ìš”ì•½ */}
            {(() => {
              const tableData = getEntityTableData();
              const totalCurr = tableData.reduce((sum, r) => sum + r.currVal, 0);
              const totalPrev = tableData.reduce((sum, r) => sum + r.prevVal, 0);
              const totalDiff = totalCurr - totalPrev;
              const totalDiffBil = Math.round(totalDiff / 100);
              const totalChange = totalPrev !== 0 ? ((totalDiff / totalPrev) * 100).toFixed(1) : 0;
              const isPositive = totalDiff >= 0;
              
              return (
                <div className="mt-3 pt-3 border-t border-zinc-200">
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-zinc-600 font-medium">ì „ì²´ YoY ë³€ë™</span>
                    <span className={`font-bold ${isPositive ? 'text-emerald-600' : 'text-rose-600'}`}>
                      {isPositive ? '+' : ''}{formatNumber(totalDiffBil)}ì–µì› ({isPositive ? '+' : ''}{totalChange}%)
                    </span>
                  </div>
                </div>
              );
            })()}
          </div>
        </div>
      </div>
    </div>
    );
  };

  // ============================================
  // ì¬ë¬´ìƒíƒœí‘œ íƒ­ ë Œë”ë§
  // ============================================
  const renderBalanceSheetTab = () => {
      // ìš´ì „ìë³¸ ê³„ì‚° (ë§¤ì¶œì±„ê¶Œ + ì¬ê³ ìì‚° - ë§¤ì…ì±„ë¬´)
    const calcWorkingCapital = (period) => {
      const bs = balanceSheetData[period];
      return (bs?.ë§¤ì¶œì±„ê¶Œ || 0) + (bs?.ì¬ê³ ìì‚° || 0) - (bs?.ë§¤ì…ì±„ë¬´ || 0);
    };

    // ROE ê³„ì‚° (ë‹¹ê¸°ìˆœì´ìµ / ìë³¸ì´ê³„ * 100)
    const calcROE = (period) => {
      const selectedQuarter = selectedPeriod.split('_')[1];
      const yearKey = getPeriodKey(selectedPeriod, 'year');
      const netIncome = incomeStatementData[yearKey]?.ë‹¹ê¸°ìˆœì´ìµ || 0;
      const equity = balanceSheetData[period]?.ìë³¸ì´ê³„ || 0;
      if (!equity || equity === 0) return 0;
      return ((netIncome / equity) * 100).toFixed(1);
    };

    // ì¡°ë‹¨ìœ„ í¬ë§· í•¨ìˆ˜ (ì–µì› ë‹¨ìœ„ ì…ë ¥ë°›ì•„ ì¡°ë‹¨ìœ„ í‘œê¸°)
    const formatTrilBil = (valueInBil) => {
      if (valueInBil === 0 || valueInBil === undefined || valueInBil === null) return '-';
      const absValue = Math.abs(valueInBil);
      const sign = valueInBil < 0 ? '-' : '';
      
      if (absValue >= 10000) {
        const tril = Math.floor(absValue / 10000);
        const bil = Math.round(absValue % 10000);
        return `${sign}${tril}ì¡° ${formatNumber(bil)}`;
      }
      return `${sign}${formatNumber(Math.round(absValue))}`;
    };

    // ìš”ì•½ ì¹´ë“œ ë°ì´í„° (ì–µì› ë‹¨ìœ„)
    const summaryCards = [
      { 
        title: 'ìì‚°ì´ê³„', 
        curr: (balanceSheetData[bsCurrentPeriod]?.ìì‚°ì´ê³„ || 0) / 100,
        prev: (balanceSheetData[bsPrevPeriod]?.ìì‚°ì´ê³„ || 0) / 100,
        unit: 'ì–µì›',
        useTril: true,
      },
      { 
        title: 'ìš´ì „ìë³¸', 
        curr: calcWorkingCapital(bsCurrentPeriod) / 100,
        prev: calcWorkingCapital(bsPrevPeriod) / 100,
        unit: 'ì–µì›',
        useTril: false,
      },
      { 
        title: 'ìë³¸ì´ê³„', 
        curr: (balanceSheetData[bsCurrentPeriod]?.ìë³¸ì´ê³„ || 0) / 100,
        prev: (balanceSheetData[bsPrevPeriod]?.ìë³¸ì´ê³„ || 0) / 100,
        unit: 'ì–µì›',
        useTril: true,
      },
      { 
        title: 'ROE', 
        curr: calcROE(bsCurrentPeriod),
        prev: calcROE(bsPrevPeriod),
        isRatio: true,
      },
    ];

    // ì¬ë¬´ìƒíƒœí‘œ í•­ëª© (ì„±ê²©ë³„ ë¶„ë¥˜ - ìœ ë™/ë¹„ìœ ë™ í†µí•©)
    const balanceItems = [
      // ìì‚°
      { key: 'í˜„ê¸ˆì„±ìì‚°', label: 'í˜„ê¸ˆì„±ìì‚°', depth: 1, selectable: true },
      { key: 'ê¸ˆìœµìƒí’ˆ', label: 'ê¸ˆìœµìƒí’ˆ', depth: 1 },
      { key: 'ë§¤ì¶œì±„ê¶Œ', label: 'ë§¤ì¶œì±„ê¶Œ', depth: 1, selectable: true },
      { key: 'ì¬ê³ ìì‚°', label: 'ì¬ê³ ìì‚°', depth: 1, selectable: true },
      { key: 'ê´€ê³„ê¸°ì—…íˆ¬ì', label: 'ê´€ê³„ê¸°ì—…íˆ¬ì', depth: 1 },
      { key: 'ìœ ë¬´í˜•ìì‚°', label: 'ìœ Â·ë¬´í˜•ìì‚°', depth: 1, selectable: true },
      { key: 'ì‚¬ìš©ê¶Œìì‚°', label: 'ì‚¬ìš©ê¶Œìì‚°', depth: 1, selectable: true },
      { key: 'ê¸°íƒ€ìì‚°', label: 'ê¸°íƒ€ìì‚°', depth: 1 },
      { key: 'ìì‚°ì´ê³„', label: 'ìì‚°ì´ê³„', bold: true, highlight: 'blue' },
      // ë¶€ì±„
      { key: 'ì°¨ì…ê¸ˆ', label: 'ì°¨ì…ê¸ˆ', depth: 1, selectable: true },
      { key: 'ë§¤ì…ì±„ë¬´', label: 'ë§¤ì…ì±„ë¬´', depth: 1, selectable: true },
      { key: 'ë¯¸ì§€ê¸‰ê¸ˆ', label: 'ë¯¸ì§€ê¸‰ê¸ˆ', depth: 1 },
      { key: 'ë¦¬ìŠ¤ë¶€ì±„', label: 'ë¦¬ìŠ¤ë¶€ì±„', depth: 1 },
      { key: 'ë³´ì¦ê¸ˆ', label: 'ë³´ì¦ê¸ˆ', depth: 1 },
      { key: 'ê¸°íƒ€ë¶€ì±„', label: 'ê¸°íƒ€ë¶€ì±„', depth: 1 },
      { key: 'ë¶€ì±„ì´ê³„', label: 'ë¶€ì±„ì´ê³„', bold: true, highlight: 'red' },
      // ìë³¸ (ì´ê³„ë§Œ)
      { key: 'ìë³¸ì´ê³„', label: 'ìë³¸ì´ê³„', bold: true, highlight: 'green' },
    ];

    // ë²•ì¸ë³„ ë°ì´í„° (ì¬ë¬´ìƒíƒœí‘œìš©) - ì—‘ì…€ì—ì„œ ì¶”ì¶œí•œ ì‹¤ì œ ë°ì´í„°
    const entityBSData = {
      '2024_4Q': {
        í˜„ê¸ˆì„±ìì‚°: { 'OC(êµ­ë‚´)': 61500, ì¤‘êµ­: 29229, í™ì½©: 6073, STë¯¸êµ­: 22881 },
        ë§¤ì¶œì±„ê¶Œ: { 'OC(êµ­ë‚´)': 134453, ì¤‘êµ­: 40081, í™ì½©: 3967, STë¯¸êµ­: 7463 },
        ì¬ê³ ìì‚°: { 'OC(êµ­ë‚´)': 214281, ì¤‘êµ­: 141223, í™ì½©: 35205, STë¯¸êµ­: 8723 },
        ìœ ë¬´í˜•ìì‚°: { 'OC(êµ­ë‚´)': 609769, ì¤‘êµ­: 10416, í™ì½©: 2479, STë¯¸êµ­: 70443 },
        ì‚¬ìš©ê¶Œìì‚°: { 'OC(êµ­ë‚´)': 146365, ì¤‘êµ­: 47203, í™ì½©: 11426, STë¯¸êµ­: 1315 },
        ì°¨ì…ê¸ˆ: { 'OC(êµ­ë‚´)': 45000, ì¤‘êµ­: 100635, í™ì½©: 0, STë¯¸êµ­: 0 },
        ë§¤ì…ì±„ë¬´: { 'OC(êµ­ë‚´)': 79795, ì¤‘êµ­: 17885, í™ì½©: 47089, STë¯¸êµ­: 6030 },
        ìì‚°ì´ê³„: { 'OC(êµ­ë‚´)': 1923504, ì¤‘êµ­: 336611, í™ì½©: 67244, STë¯¸êµ­: 112329 },
        ë¶€ì±„ì´ê³„: { 'OC(êµ­ë‚´)': 429786, ì¤‘êµ­: 252897, í™ì½©: 64912, STë¯¸êµ­: 26968 },
        ìë³¸ì´ê³„: { 'OC(êµ­ë‚´)': 1493718, ì¤‘êµ­: 83714, í™ì½©: 2333, STë¯¸êµ­: 85361 },
      },
      '2025_4Q': {
        í˜„ê¸ˆì„±ìì‚°: { 'OC(êµ­ë‚´)': 182075, ì¤‘êµ­: 9318, í™ì½©: 4446, STë¯¸êµ­: 11400 },
        ë§¤ì¶œì±„ê¶Œ: { 'OC(êµ­ë‚´)': 205309, ì¤‘êµ­: 97531, í™ì½©: 2871, STë¯¸êµ­: 16277 },
        ì¬ê³ ìì‚°: { 'OC(êµ­ë‚´)': 242024, ì¤‘êµ­: 281973, í™ì½©: 34165, STë¯¸êµ­: 12558 },
        ìœ ë¬´í˜•ìì‚°: { 'OC(êµ­ë‚´)': 605414, ì¤‘êµ­: 8114, í™ì½©: 3290, STë¯¸êµ­: 67161 },
        ì‚¬ìš©ê¶Œìì‚°: { 'OC(êµ­ë‚´)': 135457, ì¤‘êµ­: 30581, í™ì½©: 17979, STë¯¸êµ­: 945 },
        ì°¨ì…ê¸ˆ: { 'OC(êµ­ë‚´)': 0, ì¤‘êµ­: 160605, í™ì½©: 0, STë¯¸êµ­: 0 },
        ë§¤ì…ì±„ë¬´: { 'OC(êµ­ë‚´)': 139941, ì¤‘êµ­: 131315, í™ì½©: 47089, STë¯¸êµ­: 3739 },
        ìì‚°ì´ê³„: { 'OC(êµ­ë‚´)': 2145196, ì¤‘êµ­: 495765, í™ì½©: 71221, STë¯¸êµ­: 111397 },
        ë¶€ì±„ì´ê³„: { 'OC(êµ­ë‚´)': 423707, ì¤‘êµ­: 389821, í™ì½©: 69512, STë¯¸êµ­: 32762 },
        ìë³¸ì´ê³„: { 'OC(êµ­ë‚´)': 1721489, ì¤‘êµ­: 105943, í™ì½©: 1710, STë¯¸êµ­: 78635 },
      },
    };

    // ë¶„ê¸°ë³„ ë²•ì¸ë³„ ì¶”ì´ ë°ì´í„° (24.1Q ~ 25.4Q)
    const quarterlyEntityData = {
      í˜„ê¸ˆì„±ìì‚°: [
        { quarter: '24.1Q', 'OC(êµ­ë‚´)': 85000, ì¤‘êµ­: 35000, ê¸°íƒ€: 25000 },
        { quarter: '24.2Q', 'OC(êµ­ë‚´)': 78000, ì¤‘êµ­: 32000, ê¸°íƒ€: 28000 },
        { quarter: '24.3Q', 'OC(êµ­ë‚´)': 72000, ì¤‘êµ­: 30000, ê¸°íƒ€: 26000 },
        { quarter: '24.4Q', 'OC(êµ­ë‚´)': 61500, ì¤‘êµ­: 29229, ê¸°íƒ€: 28954 },
        { quarter: '25.1Q', 'OC(êµ­ë‚´)': 95000, ì¤‘êµ­: 25000, ê¸°íƒ€: 22000 },
        { quarter: '25.2Q', 'OC(êµ­ë‚´)': 120000, ì¤‘êµ­: 18000, ê¸°íƒ€: 20000 },
        { quarter: '25.3Q', 'OC(êµ­ë‚´)': 150000, ì¤‘êµ­: 12000, ê¸°íƒ€: 18000 },
        { quarter: '25.4Q', 'OC(êµ­ë‚´)': 182075, ì¤‘êµ­: 9318, ê¸°íƒ€: 15846 },
      ],
      ë§¤ì¶œì±„ê¶Œ: [
        { quarter: '24.1Q', 'OC(êµ­ë‚´)': 120000, ì¤‘êµ­: 35000, ê¸°íƒ€: 10000 },
        { quarter: '24.2Q', 'OC(êµ­ë‚´)': 125000, ì¤‘êµ­: 38000, ê¸°íƒ€: 11000 },
        { quarter: '24.3Q', 'OC(êµ­ë‚´)': 130000, ì¤‘êµ­: 39000, ê¸°íƒ€: 11200 },
        { quarter: '24.4Q', 'OC(êµ­ë‚´)': 134453, ì¤‘êµ­: 40081, ê¸°íƒ€: 11430 },
        { quarter: '25.1Q', 'OC(êµ­ë‚´)': 145000, ì¤‘êµ­: 55000, ê¸°íƒ€: 14000 },
        { quarter: '25.2Q', 'OC(êµ­ë‚´)': 165000, ì¤‘êµ­: 70000, ê¸°íƒ€: 16000 },
        { quarter: '25.3Q', 'OC(êµ­ë‚´)': 185000, ì¤‘êµ­: 85000, ê¸°íƒ€: 18000 },
        { quarter: '25.4Q', 'OC(êµ­ë‚´)': 205309, ì¤‘êµ­: 97531, ê¸°íƒ€: 19148 },
      ],
      ì¬ê³ ìì‚°: [
        { quarter: '24.1Q', 'OC(êµ­ë‚´)': 180000, ì¤‘êµ­: 100000, ê¸°íƒ€: 38000 },
        { quarter: '24.2Q', 'OC(êµ­ë‚´)': 190000, ì¤‘êµ­: 115000, ê¸°íƒ€: 40000 },
        { quarter: '24.3Q', 'OC(êµ­ë‚´)': 200000, ì¤‘êµ­: 128000, ê¸°íƒ€: 42000 },
        { quarter: '24.4Q', 'OC(êµ­ë‚´)': 214281, ì¤‘êµ­: 141223, ê¸°íƒ€: 43928 },
        { quarter: '25.1Q', 'OC(êµ­ë‚´)': 220000, ì¤‘êµ­: 180000, ê¸°íƒ€: 44000 },
        { quarter: '25.2Q', 'OC(êµ­ë‚´)': 228000, ì¤‘êµ­: 220000, ê¸°íƒ€: 45000 },
        { quarter: '25.3Q', 'OC(êµ­ë‚´)': 235000, ì¤‘êµ­: 250000, ê¸°íƒ€: 46000 },
        { quarter: '25.4Q', 'OC(êµ­ë‚´)': 242024, ì¤‘êµ­: 281973, ê¸°íƒ€: 46723 },
      ],
      ìœ ë¬´í˜•ìì‚°: [
        { quarter: '24.1Q', 'OC(êµ­ë‚´)': 620000, ì¤‘êµ­: 12000, ê¸°íƒ€: 74000 },
        { quarter: '24.2Q', 'OC(êµ­ë‚´)': 618000, ì¤‘êµ­: 11500, ê¸°íƒ€: 73500 },
        { quarter: '24.3Q', 'OC(êµ­ë‚´)': 614000, ì¤‘êµ­: 11000, ê¸°íƒ€: 73000 },
        { quarter: '24.4Q', 'OC(êµ­ë‚´)': 609769, ì¤‘êµ­: 10416, ê¸°íƒ€: 72922 },
        { quarter: '25.1Q', 'OC(êµ­ë‚´)': 608000, ì¤‘êµ­: 9800, ê¸°íƒ€: 72000 },
        { quarter: '25.2Q', 'OC(êµ­ë‚´)': 607000, ì¤‘êµ­: 9200, ê¸°íƒ€: 71000 },
        { quarter: '25.3Q', 'OC(êµ­ë‚´)': 606000, ì¤‘êµ­: 8600, ê¸°íƒ€: 70500 },
        { quarter: '25.4Q', 'OC(êµ­ë‚´)': 605414, ì¤‘êµ­: 8114, ê¸°íƒ€: 70451 },
      ],
      ì‚¬ìš©ê¶Œìì‚°: [
        { quarter: '24.1Q', 'OC(êµ­ë‚´)': 155000, ì¤‘êµ­: 52000, ê¸°íƒ€: 14000 },
        { quarter: '24.2Q', 'OC(êµ­ë‚´)': 152000, ì¤‘êµ­: 50000, ê¸°íƒ€: 13500 },
        { quarter: '24.3Q', 'OC(êµ­ë‚´)': 149000, ì¤‘êµ­: 48500, ê¸°íƒ€: 13000 },
        { quarter: '24.4Q', 'OC(êµ­ë‚´)': 146365, ì¤‘êµ­: 47203, ê¸°íƒ€: 12741 },
        { quarter: '25.1Q', 'OC(êµ­ë‚´)': 143000, ì¤‘êµ­: 42000, ê¸°íƒ€: 15000 },
        { quarter: '25.2Q', 'OC(êµ­ë‚´)': 140000, ì¤‘êµ­: 38000, ê¸°íƒ€: 17000 },
        { quarter: '25.3Q', 'OC(êµ­ë‚´)': 138000, ì¤‘êµ­: 34000, ê¸°íƒ€: 18500 },
        { quarter: '25.4Q', 'OC(êµ­ë‚´)': 135457, ì¤‘êµ­: 30581, ê¸°íƒ€: 18924 },
      ],
      ì°¨ì…ê¸ˆ: [
        { quarter: '24.1Q', 'OC(êµ­ë‚´)': 60000, ì¤‘êµ­: 80000, ê¸°íƒ€: 0 },
        { quarter: '24.2Q', 'OC(êµ­ë‚´)': 55000, ì¤‘êµ­: 88000, ê¸°íƒ€: 0 },
        { quarter: '24.3Q', 'OC(êµ­ë‚´)': 50000, ì¤‘êµ­: 95000, ê¸°íƒ€: 0 },
        { quarter: '24.4Q', 'OC(êµ­ë‚´)': 45000, ì¤‘êµ­: 100635, ê¸°íƒ€: 0 },
        { quarter: '25.1Q', 'OC(êµ­ë‚´)': 30000, ì¤‘êµ­: 120000, ê¸°íƒ€: 0 },
        { quarter: '25.2Q', 'OC(êµ­ë‚´)': 15000, ì¤‘êµ­: 140000, ê¸°íƒ€: 0 },
        { quarter: '25.3Q', 'OC(êµ­ë‚´)': 5000, ì¤‘êµ­: 150000, ê¸°íƒ€: 0 },
        { quarter: '25.4Q', 'OC(êµ­ë‚´)': 0, ì¤‘êµ­: 160605, ê¸°íƒ€: 0 },
      ],
      ë§¤ì…ì±„ë¬´: [
        { quarter: '24.1Q', 'OC(êµ­ë‚´)': 65000, ì¤‘êµ­: 12000, ê¸°íƒ€: 48000 },
        { quarter: '24.2Q', 'OC(êµ­ë‚´)': 70000, ì¤‘êµ­: 14000, ê¸°íƒ€: 50000 },
        { quarter: '24.3Q', 'OC(êµ­ë‚´)': 75000, ì¤‘êµ­: 16000, ê¸°íƒ€: 52000 },
        { quarter: '24.4Q', 'OC(êµ­ë‚´)': 79795, ì¤‘êµ­: 17885, ê¸°íƒ€: 53119 },
        { quarter: '25.1Q', 'OC(êµ­ë‚´)': 95000, ì¤‘êµ­: 50000, ê¸°íƒ€: 52000 },
        { quarter: '25.2Q', 'OC(êµ­ë‚´)': 110000, ì¤‘êµ­: 80000, ê¸°íƒ€: 51500 },
        { quarter: '25.3Q', 'OC(êµ­ë‚´)': 125000, ì¤‘êµ­: 105000, ê¸°íƒ€: 51000 },
        { quarter: '25.4Q', 'OC(êµ­ë‚´)': 139941, ì¤‘êµ­: 131315, ê¸°íƒ€: 50828 },
      ],
    };

    const entityColors = {
      'OC(êµ­ë‚´)': '#3B82F6',
      ì¤‘êµ­: '#F59E0B',
      í™ì½©: '#8B5CF6',
      STë¯¸êµ­: '#10B981',
      ì—°ê²°ì¡°ì •: '#9CA3AF',
      'ê¸°íƒ€(ì—°ê²°ì¡°ì •)': '#6B7280',
    };

    // ì¶”ì´ ê·¸ë˜í”„ìš© ìƒ‰ìƒ
    const trendColors = {
      'OC(êµ­ë‚´)': '#3B82F6',
      ì¤‘êµ­: '#F59E0B',
      ê¸°íƒ€: '#8B5CF6',
    };

    // ============================================
    // ì¬ë¬´ìƒíƒœí‘œ ë²•ì¸ë³„ ë¶„ì„ ë°ì´í„° ì •í•©ì„± ë³´ì •
    // - entityBSDataëŠ” ì—°ê²°ì¡°ì • ì „ ë²•ì¸ë³„ í•©ì‚°ì´ë¼ ì—°ê²°(BS) í•©ê³„ì™€ ë¶ˆì¼ì¹˜ ê°€ëŠ¥
    // - ì„ íƒ ê³„ì •/ê¸°ê°„ì˜ ì—°ê²° ê¸ˆì•¡(balanceSheetData)ì„ ê¸°ì¤€ìœ¼ë¡œ
    //   1) base(ë²•ì¸ë³„ í•©ì‚°) ìŠ¤ì¼€ì¼ë§
    //   2) ì°¨ì´ëŠ” 'ì—°ê²°ì¡°ì •' í•­ëª©ìœ¼ë¡œ ë³´ì •
    // ============================================
    const getBSConsolidatedTotal = (accountKey, period) => {
      const v = balanceSheetData?.[period]?.[accountKey];
      return typeof v === 'number' ? v : 0;
    };

    const getBaseBSBreakdown = (accountKey, period) => {
      const p = entityBSData?.[period];
      if (!p) return {};
      return p[accountKey] || p['ìì‚°ì´ê³„'] || {};
    };

    const getAlignedBSBreakdown = (accountKey, period) => {
      const consolidatedTotal = getBSConsolidatedTotal(accountKey, period);
      const base = getBaseBSBreakdown(accountKey, period);
      const baseKeys = Object.keys(base);

      if (baseKeys.length === 0) {
        return { ì—°ê²°ì¡°ì •: consolidatedTotal };
      }

      const baseSum = baseKeys.reduce((sum, k) => sum + (base[k] || 0), 0);
      if (baseSum === 0) {
        return { ...base, ì—°ê²°ì¡°ì •: consolidatedTotal };
      }

      const scale = consolidatedTotal / baseSum;
      const scaled = {};
      for (const k of baseKeys) {
        scaled[k] = Math.round((base[k] || 0) * scale);
      }

      const scaledSum = Object.values(scaled).reduce((sum, v) => sum + (v || 0), 0);
      const adjustment = consolidatedTotal - scaledSum;
      return { ...scaled, ì—°ê²°ì¡°ì •: adjustment };
    };

    // í‘œì‹œìš© ê·¸ë£¹í•‘: ë¹„ì¤‘ì´ ì‘ì€ ë²•ì¸ + ì—°ê²°ì¡°ì •ì„ 'ê¸°íƒ€(ì—°ê²°ì¡°ì •)'ë¡œ í•©ì‚°
    const BS_MINOR_ENTITY_RATIO_THRESHOLD = 0.03; // 3% ë¯¸ë§Œì€ ê¸°íƒ€ë¡œ í•©ì‚°
    const BS_MERGED_ENTITY_LABEL = 'ê¸°íƒ€(ì—°ê²°ì¡°ì •)';
    const BS_MAJOR_ENTITIES = ['OC(êµ­ë‚´)', 'ì¤‘êµ­'];

    // ë‹¨ì¼ ê¸°ê°„ìš© (ë„ë„› ì°¨íŠ¸ ë“±)
    const getGroupedBSBreakdown = (accountKey, period) => {
      return getGroupedBSBreakdownForComparison(accountKey, period, period);
    };

    // ë¹„êµìš©: ì „ê¸°/ë‹¹ê¸° ë‘˜ ë‹¤ë¥¼ ê³ ë ¤í•˜ì—¬, í•œ ê¸°ê°„ì´ë¼ë„ ìœ ì˜ë¯¸í•˜ë©´ ê°œë³„ë¡œ ìœ ì§€
    const getGroupedBSBreakdownForComparison = (accountKey, prevPeriod, currPeriod) => {
      const totalCurr = getBSConsolidatedTotal(accountKey, currPeriod);
      const totalPrev = getBSConsolidatedTotal(accountKey, prevPeriod);
      const alignedCurr = getAlignedBSBreakdown(accountKey, currPeriod);
      const alignedPrev = getAlignedBSBreakdown(accountKey, prevPeriod);

      // ì „ê¸°/ë‹¹ê¸° ëª¨ë‘ì˜ í‚¤ë¥¼ í•©ì§‘í•©ìœ¼ë¡œ ìˆ˜ì§‘
      const allKeys = Array.from(new Set([...Object.keys(alignedPrev), ...Object.keys(alignedCurr)]));

      const grouped = {};
      const entitiesToKeep = new Set();

      // 1. OC(êµ­ë‚´), ì¤‘êµ­ì€ í•­ìƒ ìœ ì§€
      BS_MAJOR_ENTITIES.forEach(entity => {
        if (allKeys.includes(entity)) {
          entitiesToKeep.add(entity);
        }
      });

      // 2. ì „ê¸°ë‚˜ ë‹¹ê¸° ì¤‘ í•˜ë‚˜ë¼ë„ ë°ì´í„°ê°€ ìˆê³ , ê·¸ ê¸°ê°„ì˜ ë¹„ì¤‘ì´ 3% ì´ìƒì´ë©´ ê°œë³„ë¡œ ìœ ì§€
      for (const name of allKeys) {
        if (BS_MAJOR_ENTITIES.includes(name) || name === 'ì—°ê²°ì¡°ì •' || name === 'ê¸°íƒ€') continue;

        const prevVal = alignedPrev[name] || 0;
        const currVal = alignedCurr[name] || 0;
        
        const prevRatio = totalPrev !== 0 ? Math.abs(prevVal) / Math.abs(totalPrev) : 0;
        const currRatio = totalCurr !== 0 ? Math.abs(currVal) / Math.abs(totalCurr) : 0;

        // ì „ê¸°ë‚˜ ë‹¹ê¸° ì¤‘ í•˜ë‚˜ë¼ë„ ë°ì´í„°ê°€ ìˆê³ , ê·¸ ê¸°ê°„ì˜ ë¹„ì¤‘ì´ 3% ì´ìƒì´ë©´ ê°œë³„ ìœ ì§€
        const hasDataInEitherPeriod = prevVal !== 0 || currVal !== 0;
        const isSignificantInEitherPeriod = prevRatio >= BS_MINOR_ENTITY_RATIO_THRESHOLD || currRatio >= BS_MINOR_ENTITY_RATIO_THRESHOLD;

        if (hasDataInEitherPeriod && isSignificantInEitherPeriod) {
          entitiesToKeep.add(name);
        }
      }

      // 3. ìœ ì§€í•  ë²•ì¸ë“¤ì„ groupedì— ì¶”ê°€ (ë‹¹ê¸° ê°’ì„ ì‚¬ìš©)
      entitiesToKeep.forEach(name => {
        grouped[name] = alignedCurr[name] || 0;
      });

      // 4. ë‚˜ë¨¸ì§€ëŠ” ê¸°íƒ€(ì—°ê²°ì¡°ì •)ë¡œ í¡ìˆ˜ (í•©ê³„ ì •í•©ì„± ë³´ì¥)
      const keptSum = Object.values(grouped).reduce((s, v) => s + (v || 0), 0);
      grouped[BS_MERGED_ENTITY_LABEL] = totalCurr - keptSum;

      return grouped;
    };

    // ë„ë„› ì°¨íŠ¸ ë°ì´í„° ìƒì„± í•¨ìˆ˜
    const getBSDonutData = (period) => {
      const accountData = getGroupedBSBreakdown(selectedBSAccount, period);
      const total = getBSConsolidatedTotal(selectedBSAccount, period);
      if (!accountData || total === 0) return [];

      return Object.entries(accountData)
        .map(([name, value]) => ({
          name,
          value: Math.abs(value),      // ì°¨íŠ¸ í‘œì‹œìš©(ì ˆëŒ€ê°’)
          valueRaw: value || 0,        // í…Œì´ë¸” í‘œì‹œìš©(ì›ê°’)
          ratio: total !== 0 ? ((Math.abs(value) / Math.abs(total)) * 100).toFixed(1) : '0.0',
          color:
            name === BS_MERGED_ENTITY_LABEL
              ? '#6B7280'
              : (entityColors[name] || '#9CA3AF'),
        }))
        .filter((item) => item.value > 0);
    };

    // ë„ë„› ì°¨íŠ¸ ë°ì´í„° ë¯¸ë¦¬ ê³„ì‚°
    const donutData2024 = getBSDonutData(bsPrevPeriod);
    const donutData2025 = getBSDonutData(bsCurrentPeriod);

    return (
      <div className="space-y-4">
        {/* ìš”ì•½ ì¹´ë“œ ì„¹ì…˜ */}
        <div className="grid grid-cols-4 gap-3">
          {summaryCards.map((card, idx) => {
            const curr = parseFloat(card.curr) || 0;
            const prev = parseFloat(card.prev) || 0;
            const diff = curr - prev;
            const changeRate = prev !== 0 ? ((curr - prev) / Math.abs(prev) * 100).toFixed(1) : '-';
            const isPositive = parseFloat(changeRate) >= 0;
            
            return (
              <div 
                key={idx}
                className="bg-white rounded-lg border border-zinc-200 shadow-sm p-4 hover:shadow-md transition-all duration-200"
              >
                <div className="flex items-center justify-between mb-3">
                  <span className="text-xs font-medium text-zinc-500 uppercase tracking-wide">{card.title}</span>
                  <span className={`text-xs font-semibold px-2 py-0.5 rounded ${
                    isPositive ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'
                  }`}>
                    {changeRate !== '-' ? `${isPositive ? '+' : ''}${changeRate}%` : '-'}
                  </span>
                </div>
                
                <div className="text-2xl font-bold text-zinc-900 tracking-tight">
                  {card.isRatio ? `${curr}%` : (card.useTril ? formatTrilBil(curr) : formatNumber(Math.round(curr)))}
                  {card.unit && <span className="text-sm font-normal text-zinc-500 ml-1">{card.unit}</span>}
                </div>
                
                <div className="flex items-center gap-2 mt-1 text-xs">
                  <span className="text-zinc-400">
                    ì „ë…„ {card.isRatio ? `${prev}%` : `${card.useTril ? formatTrilBil(prev) : formatNumber(Math.round(prev))}${card.unit || ''}`}
                  </span>
                  {!card.isRatio && (
                    <span className={`font-semibold ${isPositive ? 'text-emerald-600' : 'text-rose-600'}`}>
                      {isPositive ? '+' : ''}{formatNumber(Math.round(diff))}
                    </span>
                  )}
                </div>
              </div>
            );
          })}
        </div>

        {/* ì¬ë¬´ìƒíƒœí‘œ í…Œì´ë¸” & ë²•ì¸ë³„ ë¶„ì„ */}
        <div className="flex flex-col xl:flex-row gap-4">
          {/* ì¢Œì¸¡: ì¬ë¬´ìƒíƒœí‘œ í…Œì´ë¸” */}
          <div className="flex-1 min-w-0">
            <div className="bg-white rounded-lg border border-zinc-200 shadow-sm overflow-hidden">
              <div className="px-4 py-3 border-b border-zinc-200 bg-zinc-50">
                <h3 className="text-sm font-semibold text-zinc-900">ì—°ê²° ì¬ë¬´ìƒíƒœí‘œ</h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="bg-zinc-50 border-b border-zinc-200">
                      <th className="text-left px-3 py-2.5 font-semibold text-zinc-700 border-r border-zinc-200 min-w-[175px]">ê³¼ëª©</th>
                      <th className="text-center px-3 py-2 font-semibold text-zinc-600 border-r border-zinc-200 min-w-[95px]">2024.ê¸°ë§</th>
                      <th className="text-center px-3 py-2 font-semibold text-zinc-900 border-r border-zinc-200 bg-zinc-100 min-w-[95px]">
                        {selectedPeriod.replace('2025_', '').replace('Q', ' Q')} ê¸°ë§
                      </th>
                      <th className="text-center px-3 py-2 font-semibold text-zinc-600 border-r border-zinc-200 min-w-[90px]">ì¦ê°ì•¡</th>
                      <th className="text-center px-3 py-2 font-semibold text-zinc-600 min-w-[70px]">ì¦ê°ë¥ </th>
                    </tr>
                  </thead>
                  <tbody>
                    {balanceItems.map((item, idx) => {
                      const val2024 = balanceSheetData[bsPrevPeriod]?.[item.key] || 0;
                      const val2025 = balanceSheetData[bsCurrentPeriod]?.[item.key] || 0;
                      const diff = val2025 - val2024;
                      const change = calculateYoY(val2025, val2024);
                      
                      const highlightClass = item.highlight === 'blue' ? 'bg-blue-50/50' 
                        : item.highlight === 'green' ? 'bg-emerald-50/50' 
                        : item.highlight === 'red' ? 'bg-rose-50/50' 
                        : '';
                      const selectableClass = item.selectable ? 'cursor-pointer hover:bg-zinc-100' : '';
                      const isSelected = selectedBSAccount === item.key;
                      const selectedClass = isSelected ? 'bg-zinc-100 ring-1 ring-zinc-300 ring-inset' : '';
                      
                      return (
                        <tr 
                          key={idx} 
                          className={`border-b border-zinc-100 ${highlightClass} ${selectableClass} ${selectedClass}`}
                          onClick={() => item.selectable && setSelectedBSAccount(item.key)}
                        >
                          <td className={`px-3 py-2 border-r border-zinc-200 ${item.bold ? 'font-semibold text-zinc-900' : 'text-zinc-600'} ${item.depth === 1 ? 'pl-6' : ''}`}>
                            {item.label}
                          </td>
                          <td className="text-right px-3 py-2 text-zinc-500 border-r border-zinc-200 tabular-nums">{formatNumber(val2024)}</td>
                          <td className={`text-right px-3 py-2 border-r border-zinc-200 tabular-nums ${item.bold ? 'font-semibold text-zinc-900' : 'text-zinc-700'}`}>{formatNumber(val2025)}</td>
                          <td className={`text-right px-3 py-2 font-medium border-r border-zinc-200 tabular-nums ${diff >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                            {diff !== 0 ? formatNumber(diff) : '-'}
                          </td>
                          <td className={`text-right px-3 py-2 font-medium tabular-nums ${parseFloat(change) >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                            {change !== '-' ? `${change}%` : '-'}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>

            {/* ë¶„ê¸°ë³„ ë²•ì¸ë³„ ì¶”ì´ ê·¸ë˜í”„ */}
            {balanceItems.find(i => i.key === selectedBSAccount)?.selectable && quarterlyEntityData[selectedBSAccount] && (
              <div className="bg-white rounded-lg border border-zinc-200 shadow-sm p-4 mt-4">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-sm font-semibold text-zinc-900">
                    {balanceItems.find(i => i.key === selectedBSAccount)?.label || selectedBSAccount} ë¶„ê¸°ë³„ ì¶”ì´
                  </h3>
                  <div className="flex items-center gap-4">
                    {Object.entries(trendColors).map(([name, color]) => (
                      <div key={name} className="flex items-center gap-1.5">
                        <span className="w-3 h-0.5 rounded" style={{ backgroundColor: color }}></span>
                        <span className="text-xs text-zinc-500">{name}</span>
                      </div>
                    ))}
                  </div>
                </div>
                <div style={{ height: 220 }}>
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={quarterlyEntityData[selectedBSAccount]} margin={{ top: 5, right: 20, left: 10, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                      <XAxis 
                        dataKey="quarter" 
                        tick={{ fontSize: 11, fill: '#6b7280' }}
                        axisLine={{ stroke: '#d1d5db' }}
                        tickLine={{ stroke: '#d1d5db' }}
                      />
                      <YAxis 
                        tick={{ fontSize: 10, fill: '#6b7280' }}
                        axisLine={{ stroke: '#d1d5db' }}
                        tickLine={{ stroke: '#d1d5db' }}
                        tickFormatter={(value) => value >= 1000 ? `${(value / 1000).toFixed(0)}K` : value}
                      />
                      <Tooltip 
                        content={({ active, payload, label }) => {
                          if (active && payload && payload.length) {
                            return (
                              <div className="bg-white/95 backdrop-blur-sm border border-zinc-200 rounded-lg shadow-lg px-3 py-2.5 min-w-[130px]">
                                <p className="text-xs font-medium text-zinc-500 mb-1.5 pb-1.5 border-b border-zinc-100">{label}</p>
                                <div className="space-y-1">
                                  {payload.map((entry, index) => (
                                    <div key={index} className="flex items-center justify-between gap-3">
                                      <div className="flex items-center gap-1.5">
                                        <span className="w-2 h-2 rounded-full flex-shrink-0" style={{ backgroundColor: entry.color }} />
                                        <span className="text-xs text-zinc-600">{entry.dataKey}</span>
                                      </div>
                                      <span className="text-xs font-semibold text-zinc-900">{formatNumber(entry.value)}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            );
                          }
                          return null;
                        }}
                      />
                      <Line 
                        type="monotone" 
                        dataKey="OC(êµ­ë‚´)" 
                        stroke={trendColors['OC(êµ­ë‚´)']} 
                        strokeWidth={2.5}
                        dot={{ r: 4, fill: trendColors['OC(êµ­ë‚´)'], strokeWidth: 0 }}
                        activeDot={{ r: 6, strokeWidth: 2, stroke: '#fff' }}
                      />
                      <Line 
                        type="monotone" 
                        dataKey="ì¤‘êµ­" 
                        stroke={trendColors['ì¤‘êµ­']} 
                        strokeWidth={2.5}
                        dot={{ r: 4, fill: trendColors['ì¤‘êµ­'], strokeWidth: 0 }}
                        activeDot={{ r: 6, strokeWidth: 2, stroke: '#fff' }}
                      />
                      <Line 
                        type="monotone" 
                        dataKey="ê¸°íƒ€" 
                        stroke={trendColors['ê¸°íƒ€']} 
                        strokeWidth={2.5}
                        dot={{ r: 4, fill: trendColors['ê¸°íƒ€'], strokeWidth: 0 }}
                        activeDot={{ r: 6, strokeWidth: 2, stroke: '#fff' }}
                      />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
                <p className="text-xs text-zinc-400 mt-2 text-center">* ê¸°íƒ€ = í™ì½© + STë¯¸êµ­</p>
              </div>
            )}
          </div>

          {/* ìš°ì¸¡: ë²•ì¸ë³„ ë¶„ì„ */}
          <div className="w-full xl:w-[360px] flex-shrink-0 space-y-3">
            {/* ë²•ì¸ë³„ ë¶„ì„ í—¤ë” */}
            <div className="bg-white rounded-lg border border-zinc-200 shadow-sm p-4">
              <h3 className="text-sm font-semibold text-zinc-900 mb-0.5">
                {balanceItems.find(i => i.key === selectedBSAccount)?.label || selectedBSAccount} ë²•ì¸ë³„ ë¶„ì„
              </h3>
              <p className="text-xs text-zinc-400">ê¸°ë§ ê¸°ì¤€ ë²•ì¸ë³„ ë¹„ì¤‘</p>
              
              {/* ë„ë„› ì°¨íŠ¸ ì˜ì—­ */}
              <div className="flex justify-around mt-4">
                {/* 2024ë…„ ë„ë„› */}
                <div className="text-center">
                  <p className="text-xs font-medium text-zinc-500 mb-2">2024ë…„ë§</p>
                  <div style={{ width: 120, height: 120 }}>
                    {donutData2024.length > 0 ? (
                      <PieChart width={120} height={120}>
                        <Pie
                          data={donutData2024}
                          cx={60}
                          cy={60}
                          innerRadius={30}
                          outerRadius={50}
                          paddingAngle={2}
                          dataKey="value"
                        >
                          {donutData2024.map((entry, index) => (
                            <Cell key={`cell-2024-${index}`} fill={entry.color} />
                          ))}
                        </Pie>
                        <Tooltip content={<CustomPieTooltip formatter={(value) => `${formatNumber(value)} ë°±ë§Œì›`} />} />
                      </PieChart>
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-zinc-400 text-xs">ë°ì´í„° ì—†ìŒ</div>
                    )}
                  </div>
                </div>
                {/* 2025ë…„ ë„ë„› */}
                <div className="text-center">
                  <p className="text-xs font-medium text-zinc-500 mb-2">2025ë…„ë§</p>
                  <div style={{ width: 120, height: 120 }}>
                    {donutData2025.length > 0 ? (
                      <PieChart width={120} height={120}>
                        <Pie
                          data={donutData2025}
                          cx={60}
                          cy={60}
                          innerRadius={30}
                          outerRadius={50}
                          paddingAngle={2}
                          dataKey="value"
                        >
                          {donutData2025.map((entry, index) => (
                            <Cell key={`cell-2025-${index}`} fill={entry.color} />
                          ))}
                        </Pie>
                        <Tooltip content={<CustomPieTooltip formatter={(value) => `${formatNumber(value)} ë°±ë§Œì›`} />} />
                      </PieChart>
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-zinc-400 text-xs">ë°ì´í„° ì—†ìŒ</div>
                    )}
                  </div>
                </div>
              </div>
              
              {/* ë²”ë¡€ */}
              <div className="flex flex-wrap justify-center gap-3 mt-3">
                {Object.entries(entityColors).map(([name, color]) => (
                  <div key={name} className="flex items-center gap-1.5">
                    <span className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: color }}></span>
                    <span className="text-xs text-zinc-600">{name}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* ë²•ì¸ë³„ í…Œì´ë¸” */}
            <div className="bg-white rounded-lg border border-zinc-200 shadow-sm overflow-hidden">
              <table className="w-full text-sm">
                <thead>
                  <tr className="bg-zinc-50 border-b border-zinc-200">
                    <th className="text-left px-3 py-2 font-semibold text-zinc-600 min-w-[80px] whitespace-nowrap">ë²•ì¸</th>
                    <th className="text-right px-2 py-2 font-semibold text-zinc-600 min-w-[85px]">2024</th>
                    <th className="text-right px-2 py-2 font-semibold text-zinc-600 min-w-[85px]">2025</th>
                    <th className="text-right px-2 py-2 font-semibold text-zinc-600 min-w-[55px]">ë¹„ì¤‘</th>
                    <th className="text-right px-3 py-2 font-semibold text-zinc-600 min-w-[70px] whitespace-nowrap">YoY</th>
                  </tr>
                </thead>
                <tbody>
                  {donutData2025.map((entity, idx) => {
                    const prev = donutData2024.find(e => e.name === entity.name)?.valueRaw ?? donutData2024.find(e => e.name === entity.name)?.value ?? 0;
                    const curr = entity.valueRaw ?? entity.value;
                    const yoy = prev !== 0 ? ((curr - prev) / prev * 100).toFixed(1) : '-';
                    const isPositive = parseFloat(yoy) >= 0;
                    
                    return (
                      <tr key={idx} className="border-b border-zinc-100">
                        <td className="px-3 py-2 text-zinc-700 whitespace-nowrap">
                          <span className="inline-block w-2 h-2 rounded-full mr-1.5" style={{ backgroundColor: entity.color }}></span>
                          {entity.name}
                        </td>
                        <td className="text-right px-2 py-2 text-zinc-500 tabular-nums">{formatNumber(prev)}</td>
                        <td className="text-right px-2 py-2 font-medium text-zinc-900 tabular-nums">{formatNumber(curr)}</td>
                        <td className="text-right px-2 py-2 text-zinc-600 tabular-nums">{entity.ratio}%</td>
                        <td className={`text-right px-3 py-2 font-medium tabular-nums whitespace-nowrap ${isPositive ? 'text-emerald-600' : 'text-rose-600'}`}>
                          {yoy !== '-' ? `${isPositive ? '+' : ''}${yoy}%` : '-'}
                        </td>
                      </tr>
                    );
                  })}
                  {/* í•©ê³„ í–‰ */}
                  {(() => {
                    const totalPrev = getBSConsolidatedTotal(selectedBSAccount, bsPrevPeriod);
                    const totalCurr = getBSConsolidatedTotal(selectedBSAccount, bsCurrentPeriod);
                    const totalYoy = totalPrev !== 0 ? ((totalCurr - totalPrev) / totalPrev * 100).toFixed(1) : '-';
                    const isPositive = parseFloat(totalYoy) >= 0;

                    return (
                      <tr className="bg-zinc-50 font-medium">
                        <td className="px-3 py-2 text-zinc-900 whitespace-nowrap">í•©ê³„</td>
                        <td className="text-right px-2 py-2 text-zinc-700 tabular-nums">{formatNumber(totalPrev)}</td>
                        <td className="text-right px-2 py-2 text-zinc-900 tabular-nums">{formatNumber(totalCurr)}</td>
                        <td className="text-right px-2 py-2 text-zinc-700 tabular-nums">100%</td>
                        <td className={`text-right px-3 py-2 tabular-nums whitespace-nowrap ${totalYoy === '-' ? 'text-zinc-400' : isPositive ? 'text-emerald-600' : 'text-rose-600'}`}>
                          {totalYoy !== '-' ? `${isPositive ? '+' : ''}${totalYoy}%` : '-'}
                        </td>
                      </tr>
                    );
                  })()}
                </tbody>
              </table>
            </div>

            {/* ì£¼ìš” ì¸ì‚¬ì´íŠ¸ */}
            <div className="bg-white rounded-lg border border-zinc-200 shadow-sm p-4">
              <h3 className="text-sm font-semibold text-zinc-900 mb-3">
                {balanceItems.find(i => i.key === selectedBSAccount)?.label || selectedBSAccount} ì¦ê° ë¶„ì„
              </h3>
              <div className="space-y-2 text-xs">
                {(() => {
                  const curr2025 = getAlignedBSBreakdown(selectedBSAccount, bsCurrentPeriod);
                  const curr2024 = getAlignedBSBreakdown(selectedBSAccount, bsPrevPeriod);
                  
                  // ë²•ì¸ë³„ ì¦ê° ê³„ì‚°
                  const changes = Object.keys(curr2025).map(entity => ({
                    name: entity,
                    diff: curr2025[entity] - curr2024[entity],
                    rate: curr2024[entity] !== 0 ? ((curr2025[entity] - curr2024[entity]) / Math.abs(curr2024[entity]) * 100).toFixed(1) : 0
                  })).sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));
                  
                  const total2025 = getBSConsolidatedTotal(selectedBSAccount, bsCurrentPeriod);
                  const total2024 = getBSConsolidatedTotal(selectedBSAccount, bsPrevPeriod);
                  const totalDiff = total2025 - total2024;
                  
                  return (
                    <>
                      <div className="p-2 bg-blue-50 rounded border-l-2 border-blue-400">
                        <p className="font-medium text-blue-800">ì „ì²´ YoY</p>
                        <p className="text-blue-600 text-[11px] mt-0.5">
                          {totalDiff >= 0 ? '+' : ''}{formatNumber(totalDiff)}ë°±ë§Œì› 
                          ({total2024 !== 0 ? `${((total2025 - total2024) / Math.abs(total2024) * 100).toFixed(1)}%` : '-'})
                        </p>
                      </div>
                      <div className={`p-2 rounded border-l-2 ${changes[0]?.diff >= 0 ? 'bg-emerald-50 border-emerald-400' : 'bg-rose-50 border-rose-400'}`}>
                        <p className={`font-medium ${changes[0]?.diff >= 0 ? 'text-emerald-800' : 'text-rose-800'}`}>
                          ìµœëŒ€ {changes[0]?.diff >= 0 ? 'ì¦ê°€' : 'ê°ì†Œ'}: {changes[0]?.name}
                        </p>
                        <p className={`text-[11px] mt-0.5 ${changes[0]?.diff >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                          {changes[0]?.diff >= 0 ? '+' : ''}{formatNumber(changes[0]?.diff)}ë°±ë§Œì› ({changes[0]?.rate}%)
                        </p>
                      </div>
                      {changes[1] && Math.abs(changes[1].diff) > 0 && (
                        <div className={`p-2 rounded border-l-2 ${changes[1]?.diff >= 0 ? 'bg-amber-50 border-amber-400' : 'bg-zinc-50 border-zinc-300'}`}>
                          <p className={`font-medium ${changes[1]?.diff >= 0 ? 'text-amber-800' : 'text-zinc-700'}`}>
                            {changes[1]?.diff >= 0 ? 'ì¦ê°€' : 'ê°ì†Œ'}: {changes[1]?.name}
                          </p>
                          <p className={`text-[11px] mt-0.5 ${changes[1]?.diff >= 0 ? 'text-amber-600' : 'text-zinc-500'}`}>
                            {changes[1]?.diff >= 0 ? '+' : ''}{formatNumber(changes[1]?.diff)}ë°±ë§Œì› ({changes[1]?.rate}%)
                          </p>
                        </div>
                      )}
                    </>
                  );
                })()}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // ============================================
  // ë©”ì¸ ë Œë”ë§
  // ============================================
  return (
    <div className="min-h-screen bg-zinc-50">
      <div className="max-w-6xl mx-auto p-4">
        {/* í—¤ë” */}
        <div className="mb-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <div className="w-9 h-9 bg-zinc-900 rounded-lg flex items-center justify-center">
                <span className="text-white font-bold text-sm">F&F</span>
              </div>
              <div>
                <h1 className="text-xl font-semibold tracking-tight text-zinc-900">F&F Corporation</h1>
                <p className="text-xs text-zinc-500">
                  {selectedPeriod.replace('_', ' ').replace('Q', ' Q')} ì—°ê²° ì¬ë¬´ì œí‘œ
                </p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <select
                value={selectedPeriod}
                onChange={(e) => setSelectedPeriod(e.target.value)}
                className="px-3 py-1.5 bg-zinc-900 text-white text-xs font-medium rounded border-none outline-none cursor-pointer hover:bg-zinc-800 transition-colors"
              >
                <option value="2025_Q1">FY2025 Q1</option>
                <option value="2025_Q2">FY2025 Q2</option>
                <option value="2025_Q3">FY2025 Q3</option>
                <option value="2025_Q4">FY2025 Q4</option>
              </select>
            </div>
          </div>
        </div>

        {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
        <div className="mb-4">
          <div className="inline-flex p-0.5 bg-zinc-100 rounded-lg border border-zinc-200">
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`px-4 py-2 text-sm font-medium rounded transition-all duration-150 ${
                  activeTab === tab.id
                    ? 'bg-white text-zinc-900 border border-zinc-200'
                    : 'text-zinc-500 hover:text-zinc-700'
                }`}
              >
                {tab.label}
              </button>
            ))}
          </div>
        </div>

        {/* íƒ­ ì»¨í…ì¸  */}
        <div>
          {activeTab === 'summary' && renderSummaryTab()}
          {activeTab === 'income' && renderIncomeTab()}
          {activeTab === 'balance' && renderBalanceSheetTab()}
        </div>

        {/* í‘¸í„° */}
        <div className="mt-6 pt-4 border-t border-zinc-200">
          <p className="text-xs text-zinc-400 text-center">
            Â© 2025 F&F Corporation | ë‹¨ìœ„: ë°±ë§Œì›
          </p>
        </div>
      </div>
    </div>
  );
}
